<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mad Libs Math Worksheet Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .math-type-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #667eea;
        }

        .math-type-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .math-type-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1.1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .math-type-dropdown:focus {
            outline: none;
            border-color: #764ba2;
        }

        .story-preview {
            background: #fff4e6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #ff9800;
        }

        .story-preview h3 {
            color: #ff9800;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.4em;
        }

        .story-description {
            text-align: center;
            color: #666;
            font-size: 1em;
            line-height: 1.5;
        }

        .refresh-button {
            width: 100%;
            padding: 12px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 25px;
        }

        .refresh-button:hover {
            transform: scale(1.02);
            background: #f57c00;
        }

        .refresh-button:active {
            transform: scale(0.98);
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 1.1em;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #764ba2;
        }

        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: scale(1.05);
        }

        .button:active {
            transform: scale(0.98);
        }

        /* Worksheet styles */
        .worksheet {
            display: none;
        }

        .worksheet.active {
            display: block;
        }

        .worksheet-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .worksheet-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .worksheet-info {
            color: #666;
            font-size: 1em;
        }

        .story-problem {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
        }

        .problem-number {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .problem-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }

        .problem-image {
            display: block;
            margin: 15px auto;
            width: 150px;
            height: 150px;
            border-radius: 10px;
            background: #f0f0f0;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            object-fit: contain;
        }
        
        .problem-image-error {
            display: block;
            margin: 15px auto;
            width: 150px;
            height: 150px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }

        .answer-line {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px dashed #ccc;
        }

        .answer-label {
            font-weight: bold;
            color: #555;
        }

        .answer-space {
            display: inline-block;
            min-width: 100px;
            border-bottom: 2px solid #333;
            margin-left: 10px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .button-secondary {
            background: #6c757d;
        }

        .answer-line {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding-top: 20px;
            border-top: 2px dashed #ccc;
        }

        .answer-space {
            display: inline-block;
            border-bottom: 2px solid #333;
            vertical-align: middle;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 20px;
                max-width: 100%;
            }

            .button-group {
                display: none;
            }

            .input-section {
                display: none;
            }

            .worksheet-header {
                page-break-after: avoid;
            }

            .story-problem {
                page-break-inside: avoid;
                background: white;
                border: 1px solid #ccc;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section" id="inputSection">
            <h1>üéâ Mad Libs Math Worksheet üéâ</h1>
            <p class="subtitle">Fill in the blanks to create your own silly math story!</p>
            
            <div class="story-preview" id="storyPreview">
                <h3 id="storyTitle">Loading...</h3>
                <p class="story-description" id="storyDescription">Loading description...</p>
            </div>

            <button class="refresh-button" onclick="refreshStory()">üîÑ Get a Different Story</button>
            
            <div class="math-type-section">
                <h3>Choose Your Math Type:</h3>
                <select class="math-type-dropdown" id="mathTypeSelect">
                    <option value="random">Random Mix üé≤</option>
                    <option value="addition">Addition ‚ûï</option>
                    <option value="subtraction">Subtraction ‚ûñ</option>
                    <option value="multiplication">Multiplication ‚úñÔ∏è</option>
                    <option value="division">Division ‚ûó</option>
                </select>
            </div>

            <div id="madLibsForm"></div>
            
            <button class="button" onclick="generateWorksheet()">Create My Worksheet! üìù</button>
        </div>

        <div class="worksheet" id="worksheet">
            <div class="worksheet-header">
                <div class="worksheet-title">My Math Adventure!</div>
                <div class="worksheet-info">Name: _________________ Date: _________________</div>
            </div>
            
            <div id="worksheetContent"></div>

            <div class="button-group">
                <button class="button" onclick="printWorksheet()">Print Worksheet üñ®Ô∏è</button>
                <button class="button button-secondary" onclick="startOver()">Start Over üîÑ</button>
            </div>
        </div>
    </div>

    <script>
        // Expanded story templates with more variety for dynamic generation
        // To make it more robust, we've added 5 new story structures, fixed potential errors (e.g., emoji mappings, image fallbacks),
        // and made problem selection more flexible (now generates up to 8 problems if available, but caps at 5 for worksheet length).
        // For modularity, prompts and problems are structured similarly across themes.
        // Images are generated with better theme representation by using problemText for potential captions (optional in meme style).
        // To maximize stories, we can combinatorially refresh, and the refresh function ensures variety.
        const storyTemplates = [
            {
                title: "The Great Pet Parade",
                description: "Join a wacky parade full of colorful animals, silly sounds, and tasty treats!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Type of Animal (plural)", type: "text" },
                    { label: "Silly Color", type: "text" },
                    { label: "Type of Food", type: "text" },
                    { label: "Funny Sound", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} was organizing the town's first ever ${animal} parade! In the morning, ${num1} ${color} ${animal} arrived saying "${sound}!" In the afternoon, ${num2} more ${animal} joined the parade. How many ${animal} were in the parade altogether?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} prepared ${num1} boxes of ${food} for the ${animal} to eat during the parade. The ${animal} were so excited they went "${sound}!" and ate ${num2} boxes right away! How many boxes of ${food} were left for later?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `Each ${animal.slice(0, -1)} in the parade wore ${num2} ${color} ribbons. There were ${num1} ${animal} marching and saying "${sound}!" How many ${color} ribbons were there in total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `After the parade, ${name} had ${num1} pieces of ${food} to share equally among ${divisor} groups of ${animal}. Each group would say "${sound}!" when they got their share. How many pieces of ${food} did each group get?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `The parade was such a success! ${num1} people came to watch in the morning, and ${num2} more arrived in the afternoon, all cheering as the ${color} ${animal} went "${sound}!" How many people watched the parade in total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} gave out ${num1} ${color} balloons at the parade. The ${animal} popped ${num2} balloons by accident while saying "${sound}!" How many balloons were still floating?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `At the end of the parade, ${name} took ${num1} photos of groups of ${animal}. Each photo had ${num2} ${color} ${animal} saying "${sound}!" How many ${animal} were in all the photos combined?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, color, food, sound] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${animal} collected ${num1} pieces of ${food} during the parade. They wanted to put them into ${divisor} ${color} boxes, with the same amount in each box. Every time they filled a box, they'd say "${sound}!" How many pieces of ${food} went in each box?`;
                        }
                    }
                ]
            },
            {
                title: "Space Adventure with Captain [Name]",
                description: "Blast off to outer space and meet friendly aliens on a faraway planet!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Alien Creature (plural)", type: "text" },
                    { label: "Weird Color", type: "text" },
                    { label: "Space Food", type: "text" },
                    { label: "Planet Name", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const num1 = random(7, 16);
                            const num2 = random(4, 11);
                            return `Captain ${name} landed the spaceship on planet ${planet} and discovered ${num1} friendly ${color} ${alien}. Then ${num2} more ${alien} came out from behind a crater to say hello! How many ${alien} did Captain ${name} meet?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const num1 = random(18, 32);
                            const num2 = random(6, 14);
                            return `Captain ${name} brought ${num1} containers of ${food} to share with the ${alien} on planet ${planet}. The ${alien} were so hungry they ate ${num2} containers! How many containers of ${food} were left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const num1 = random(3, 7);
                            const num2 = random(4, 8);
                            return `Each ${alien.slice(0, -1)} on planet ${planet} had ${num2} ${color} antennae on their head. Captain ${name} counted ${num1} ${alien}. How many antennae were there in all?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const divisor = random(2, 5);
                            const quotient = random(5, 9);
                            const num1 = divisor * quotient;
                            return `The ${alien} gave Captain ${name} ${num1} ${color} space crystals from planet ${planet} to take home. Captain ${name} wanted to put them equally into ${divisor} boxes. How many crystals went in each box?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const num1 = random(9, 17);
                            const num2 = random(5, 13);
                            return `Before leaving planet ${planet}, Captain ${name} collected ${num1} samples of ${food} from the north crater and ${num2} samples from the south crater. The ${alien} waved goodbye! How many samples of ${food} did Captain ${name} collect?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const num1 = random(22, 38);
                            const num2 = random(9, 16);
                            return `Captain ${name} took ${num1} photos of the ${color} ${alien} on planet ${planet}. When returning to Earth, ${num2} photos got deleted by accident. How many photos did Captain ${name} still have?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `Captain ${name} visited ${num1} different caves on planet ${planet}. In each cave, there were ${num2} ${alien} families enjoying ${food}. How many ${alien} families did Captain ${name} see altogether?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, alien, color, food, planet] = words;
                            const divisor = random(3, 6);
                            const quotient = random(4, 7);
                            const num1 = divisor * quotient;
                            return `The ${alien} on planet ${planet} gave Captain ${name} ${num1} pieces of ${color} ${food} as a farewell gift. Captain ${name} divided them equally among ${divisor} crew members on the spaceship. How many pieces did each crew member get?`;
                        }
                    }
                ]
            },
            {
                title: "The Magical Bakery Mix-Up",
                description: "Help run a magical bakery where desserts appear with a magic word and creatures help bake!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Magical Creature (plural)", type: "text" },
                    { label: "Type of Dessert", type: "text" },
                    { label: "Silly Ingredient", type: "text" },
                    { label: "Magic Word", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const num1 = random(6, 14);
                            const num2 = random(4, 12);
                            return `${name} opened a magical bakery with help from ${creature}. On Monday, they baked ${num1} magical ${dessert}. When ${name} said the magic word "${magic}!", ${num2} more ${dessert} appeared! How many ${dessert} did they have?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const num1 = random(16, 28);
                            const num2 = random(7, 13);
                            return `${name} sprinkled ${ingredient} on ${num1} batches of ${dessert}. Some ${creature} got too excited hearing "${magic}!" and accidentally ate ${num2} batches. How many batches of ${dessert} were left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `Each ${creature.slice(0, -1)} helper made ${num2} trays of ${dessert} with ${ingredient} on top. There were ${num1} ${creature} working in ${name}'s bakery, all chanting "${magic}!" How many trays of ${dessert} did they make in total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const divisor = random(2, 4);
                            const quotient = random(6, 10);
                            const num1 = divisor * quotient;
                            return `${name} made ${num1} special ${dessert} using secret ${ingredient}. The ${creature} said "${magic}!" and the ${dessert} needed to be packed equally into ${divisor} magical boxes. How many ${dessert} went in each box?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const num1 = random(8, 16);
                            const num2 = random(5, 12);
                            return `The grand opening was a huge success! ${num1} customers came in the morning to buy ${dessert}, and ${num2} more arrived in the afternoon after hearing the ${creature} shout "${magic}!" How many customers visited ${name}'s bakery?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const num1 = random(20, 34);
                            const num2 = random(8, 15);
                            return `${name} decorated ${num1} ${dessert} with sparkly ${ingredient}. When a ${creature.slice(0, -1)} sneezed and said "${magic}!", the sparkles flew off of ${num2} ${dessert}. How many ${dessert} still had their decorations?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const num1 = random(4, 7);
                            const num2 = random(4, 8);
                            return `${name} hosted ${num1} birthday parties at the bakery. Each party got ${num2} ${dessert} with ${ingredient} and a song where everyone sang "${magic}!" How many ${dessert} did ${name} serve at all the parties?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, dessert, ingredient, magic] = words;
                            const divisor = random(3, 5);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `At the end of the day, the ${creature} made ${num1} leftover ${dessert} with ${ingredient}. ${name} said "${magic}!" and divided them equally among ${divisor} ${creature} to take home. How many ${dessert} did each ${creature.slice(0, -1)} get?`;
                        }
                    }
                ]
            },
            {
                title: "The Wild Carnival Adventure",
                description: "Play games, win prizes, and have fun with silly animals at the most exciting carnival ever!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Funny Animal (plural)", type: "text" },
                    { label: "Carnival Game", type: "text" },
                    { label: "Prize Item (plural)", type: "text" },
                    { label: "Excitement Word", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const num1 = random(8, 15);
                            const num2 = random(5, 11);
                            return `${name} arrived at the carnival and saw ${num1} ${animal} playing ${game}. The ${animal} were shouting "${exclaim}!" Then ${num2} more ${animal} ran over to join the fun. How many ${animal} were playing ${game}?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const num1 = random(17, 29);
                            const num2 = random(6, 13);
                            return `${name} won ${num1} ${prize} playing ${game} at the carnival! The ${animal} yelled "${exclaim}!" and ${name} gave ${num2} ${prize} to them as gifts. How many ${prize} did ${name} have left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `At the ${game} booth, there were ${num1} rounds. In each round, ${num2} ${animal} won ${prize} and celebrated by saying "${exclaim}!" How many ${animal} won ${prize} altogether?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 9);
                            const num1 = divisor * quotient;
                            return `${name} and the ${animal} won ${num1} ${prize} at the ${game} booth. They said "${exclaim}!" and decided to share them equally among ${divisor} groups. How many ${prize} did each group get?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const num1 = random(9, 16);
                            const num2 = random(6, 13);
                            return `During the afternoon, ${num1} ${animal} rode the ferris wheel, all shouting "${exclaim}!" Later, ${num2} more ${animal} joined them for a second ride with ${name}. How many ${animal} went on rides in total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const num1 = random(21, 35);
                            const num2 = random(8, 16);
                            return `${name} bought ${num1} tickets to play ${game}. After using ${num2} tickets (with ${animal} cheering "${exclaim}!" each time), how many tickets did ${name} have remaining?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} played ${game} ${num1} times. Each time, ${name} won ${num2} ${prize}, and the ${animal} yelled "${exclaim}!" every single time! How many ${prize} did ${name} win in all?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, game, prize, exclaim] = words;
                            const divisor = random(3, 6);
                            const quotient = random(4, 7);
                            const num1 = divisor * quotient;
                            return `Before leaving the carnival, the ${animal} collected ${num1} ${prize} from playing ${game}. They said "${exclaim}!" one last time and split them equally into ${divisor} bags. How many ${prize} went in each bag?`;
                        }
                    }
                ]
            },
            {
                title: "Pirate Treasure Hunt",
                description: "Sail the seven seas with your crew and search for hidden treasure on mysterious islands!",
                prompts: [
                    { label: "Your Pirate Name", type: "text" },
                    { label: "Type of Sea Creature (plural)", type: "text" },
                    { label: "Treasure Item (plural)", type: "text" },
                    { label: "Island Name", type: "text" },
                    { label: "Pirate Saying", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const num1 = random(10, 18);
                            const num2 = random(6, 14);
                            return `Captain ${name} spotted ${num1} ${creature} near ${island} Island. After shouting "${saying}!", the crew discovered ${num2} more ${creature} swimming by. How many ${creature} did they see altogether?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const num1 = random(19, 33);
                            const num2 = random(7, 15);
                            return `Captain ${name} found a chest with ${num1} ${treasure} on ${island} Island! "${saying}!" yelled the crew. They gave ${num2} ${treasure} to the ${creature} they met. How many ${treasure} does Captain ${name} have left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const num1 = random(4, 7);
                            const num2 = random(5, 9);
                            return `On ${island} Island, Captain ${name} found ${num1} treasure chests. Each chest had ${num2} ${treasure} inside. Every time they opened a chest, the crew shouted "${saying}!" How many ${treasure} did they find in total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const divisor = random(2, 4);
                            const quotient = random(6, 10);
                            const num1 = divisor * quotient;
                            return `Captain ${name} and the crew collected ${num1} ${treasure} from ${island} Island. "${saying}!" they cheered as they split them equally among ${divisor} ships. How many ${treasure} did each ship get?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const num1 = random(12, 20);
                            const num2 = random(8, 16);
                            return `While sailing away from ${island} Island, Captain ${name} saw ${num1} friendly ${creature}. Then ${num2} more ${creature} joined them, all singing "${saying}!" How many ${creature} were swimming with the ship?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const num1 = random(24, 40);
                            const num2 = random(10, 18);
                            return `Captain ${name} started with ${num1} pieces of treasure map. After solving riddles near ${island} Island, ${num2} pieces were used up. The ${creature} cried "${saying}!" How many map pieces remain?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const num1 = random(6, 10);
                            const num2 = random(3, 6);
                            return `Captain ${name} visited ${num1} caves on ${island} Island. In each cave, there were ${num2} ${treasure} guarded by ${creature}. Every cave echoed with "${saying}!" How many ${treasure} were there in all the caves?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, treasure, island, saying] = words;
                            const divisor = random(3, 5);
                            const quotient = random(5, 9);
                            const num1 = divisor * quotient;
                            return `The ${creature} helped Captain ${name} find ${num1} ${treasure} on ${island} Island. "${saying}!" they celebrated, dividing the treasure equally into ${divisor} pouches. How many ${treasure} went in each pouch?`;
                        }
                    }
                ]
            },
            {
                title: "Dinosaur Discovery",
                description: "Travel back in time to meet amazing dinosaurs and explore the prehistoric world!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Type of Dinosaur (plural)", type: "text" },
                    { label: "Prehistoric Plant (plural)", type: "text" },
                    { label: "Dinosaur Sound", type: "text" },
                    { label: "Color", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const num1 = random(7, 15);
                            const num2 = random(4, 11);
                            return `${name} traveled back in time and spotted ${num1} ${color} ${dino} munching on ${plant}. They went "${sound}!" Then ${num2} more ${dino} stomped over to join them. How many ${dino} were there in all?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const num1 = random(18, 30);
                            const num2 = random(6, 13);
                            return `${name} found ${num1} delicious ${plant} growing near the ${dino}. The ${dino} went "${sound}!" and ate ${num2} of the ${plant}. How many ${plant} were left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const num1 = random(3, 7);
                            const num2 = random(4, 8);
                            return `${name} watched ${num1} groups of ${color} ${dino}. Each group had ${num2} ${dino} that roared "${sound}!" as they ate ${plant}. How many ${dino} did ${name} see altogether?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const divisor = random(2, 5);
                            const quotient = random(5, 9);
                            const num1 = divisor * quotient;
                            return `${name} collected ${num1} ${plant} for the ${dino}. The ${dino} said "${sound}!" as ${name} divided the ${plant} equally among ${divisor} nests. How many ${plant} went in each nest?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const num1 = random(9, 17);
                            const num2 = random(5, 12);
                            return `In the morning, ${name} saw ${num1} baby ${dino} hatching from ${color} eggs. They chirped "${sound}!" By afternoon, ${num2} more babies hatched. How many baby ${dino} hatched in total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const num1 = random(22, 36);
                            const num2 = random(9, 16);
                            return `${name} counted ${num1} ${color} footprints left by the ${dino} near the ${plant}. After it rained, ${num2} footprints were washed away. The ${dino} roared "${sound}!" How many footprints remained?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 6);
                            return `${name} discovered ${num1} ${color} ${dino}. Each ${dino.slice(0, -1)} ate ${num2} bunches of ${plant} per day, making a "${sound}!" sound with each bite. How many bunches of ${plant} did they eat altogether?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, dino, plant, sound, color] = words;
                            const divisor = random(3, 6);
                            const quotient = random(4, 7);
                            const num1 = divisor * quotient;
                            return `The ${dino} helped ${name} gather ${num1} ${color} ${plant}. With a loud "${sound}!", they organized them into ${divisor} equal piles. How many ${plant} were in each pile?`;
                        }
                    }
                ]
            },
            {
                title: "Superhero Training Academy",
                description: "Join the superhero academy and use your powers to complete amazing training missions!",
                prompts: [
                    { label: "Your Superhero Name", type: "text" },
                    { label: "Superpower", type: "text" },
                    { label: "Training Object (plural)", type: "text" },
                    { label: "Superhero Catchphrase", type: "text" },
                    { label: "Villain Type (plural)", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const num1 = random(8, 16);
                            const num2 = random(5, 12);
                            return `${name} used their ${power} to save ${num1} ${object} from the ${villain}. "${phrase}!" shouted ${name}. Then ${num2} more ${object} needed saving. How many ${object} did ${name} save in total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const num1 = random(17, 29);
                            const num2 = random(6, 13);
                            return `At the training academy, ${name} had ${num1} ${object} to practice their ${power}. After training and yelling "${phrase}!", ${num2} ${object} were used up stopping the ${villain}. How many ${object} are left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 7);
                            return `${name} completed ${num1} training missions using ${power}. In each mission, ${name} collected ${num2} ${object} while fighting ${villain}. Every time, ${name} said "${phrase}!" How many ${object} did ${name} collect?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const divisor = random(2, 5);
                            const quotient = random(5, 10);
                            const num1 = divisor * quotient;
                            return `${name} defeated ${villain} and rescued ${num1} ${object} using ${power}. "${phrase}!" ${name} exclaimed, then divided the ${object} equally among ${divisor} superhero teams. How many ${object} did each team get?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const num1 = random(10, 18);
                            const num2 = random(7, 14);
                            return `${name} trained ${num1} new superheroes in the art of ${power} in the morning. In the afternoon, ${num2} more heroes joined to learn how to stop ${villain}. Everyone cheered "${phrase}!" How many superheroes trained that day?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const num1 = random(20, 34);
                            const num2 = random(8, 15);
                            return `The academy gave ${name} ${num1} ${object} to upgrade their ${power}. During a battle with ${villain}, ${num2} ${object} were destroyed. ${name} yelled "${phrase}!" How many ${object} does ${name} still have?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const num1 = random(5, 9);
                            const num2 = random(4, 7);
                            return `${name} faced ${num1} waves of ${villain} attacks. In each wave, ${name} used ${power} to protect ${num2} ${object}. After each wave, ${name} shouted "${phrase}!" How many ${object} were protected in all?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, power, object, phrase, villain] = words;
                            const divisor = random(3, 6);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `Using ${power}, ${name} recovered ${num1} stolen ${object} from the ${villain}. "${phrase}!" ${name} declared victoriously, organizing them into ${divisor} safe vaults. How many ${object} went in each vault?`;
                        }
                    }
                ]
            },
            // New story structure 1: Underwater Exploration (Discovery theme: finding and collecting in a new environment)
            {
                title: "Underwater Exploration with [Name]",
                description: "Dive deep into the ocean to explore coral reefs, meet sea creatures, and discover hidden treasures!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Sea Creature (plural)", type: "text" },
                    { label: "Ocean Color", type: "text" },
                    { label: "Type of Treasure", type: "text" },
                    { label: "Bubbly Sound", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} dived into the ${color} ocean and saw ${num1} ${creature} swimming around. They made a "${sound}!" Then ${num2} more ${creature} joined. How many ${creature} in total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} found ${num1} pieces of ${treasure} on the seabed. The ${creature} took ${num2} pieces while saying "${sound}!" How many pieces of ${treasure} left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `Each ${creature.slice(0, -1)} carried ${num2} ${color} shells. There were ${num1} ${creature} exploring with ${name}, all making "${sound}!" How many shells in total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} collected ${num1} ${treasure} to share with ${divisor} groups of ${creature}. Each group bubbled "${sound}!" How many ${treasure} per group?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} explored ${num1} coral reefs in the morning. In the afternoon, ${num2} more reefs were found with ${creature} saying "${sound}!" How many reefs total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} had ${num1} air tanks for the dive. After exploring with ${creature}, ${num2} tanks were used up amid "${sound}!" How many tanks left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} discovered ${num1} shipwrecks. Each had ${num2} chests of ${treasure}, with ${creature} exclaiming "${sound}!" How many chests total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, color, treasure, sound] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${creature} shared ${num1} ${color} pearls with ${name}. They divided them into ${divisor} bags with "${sound}!" How many pearls per bag?`;
                        }
                    }
                ]
            },
            // New story structure 2: Farmyard Shenanigans (Building/Growth theme: growing, harvesting, and managing resources)
            {
                title: "Farmyard Shenanigans with [Name]",
                description: "Help manage a fun farm with animals, crops, and daily adventures in the countryside!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Farm Animal (plural)", type: "text" },
                    { label: "Bright Color", type: "text" },
                    { label: "Type of Crop (plural)", type: "text" },
                    { label: "Animal Noise", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} fed ${num1} ${color} ${animal} on the farm. They made "${noise}!" Then ${num2} more ${animal} arrived. How many ${animal} total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} harvested ${num1} ${crop}. The ${animal} ate ${num2} while saying "${noise}!" How many ${crop} left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `Each of the ${num1} barns had ${num2} ${color} ${animal}. They all made "${noise}!" How many ${animal} on the farm?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} had ${num1} ${crop} to divide among ${divisor} groups of ${animal}. Each group went "${noise}!" How many ${crop} per group?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} planted ${num1} rows of ${crop} in the morning. In the afternoon, ${num2} more rows with ${animal} helping and making "${noise}!" How many rows total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} had ${num1} eggs from the ${color} ${animal}. After selling ${num2} at market amid "${noise}!", how many eggs left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} built ${num1} fences. Each fence had ${num2} ${animal} behind it, all saying "${noise}!" How many ${animal} enclosed?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, color, crop, noise] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${animal} gathered ${num1} ${color} ${crop}. ${name} divided them into ${divisor} baskets with "${noise}!" How many ${crop} per basket?`;
                        }
                    }
                ]
            },
            // New story structure 3: Jungle Quest (Adventure/Quest theme: journeying, overcoming obstacles, finding items)
            {
                title: "Jungle Quest with Explorer [Name]",
                description: "Venture into the dense jungle to discover ancient ruins, exotic animals, and lost artifacts!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Jungle Animal (plural)", type: "text" },
                    { label: "Vibrant Color", type: "text" },
                    { label: "Artifact Type (plural)", type: "text" },
                    { label: "Adventure Call", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} entered the jungle and met ${num1} ${color} ${animal}. They shouted "${call}!" Then ${num2} more ${animal} appeared. How many ${animal} total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} discovered ${num1} ${artifact} in ruins. The ${animal} hid ${num2} while yelling "${call}!" How many ${artifact} left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `${name} crossed ${num1} rivers. Each had ${num2} ${color} ${animal} guarding it, all calling "${call}!" How many ${animal} encountered?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} found ${num1} ${artifact} to share with ${divisor} tribes of ${animal}. Each tribe responded with "${call}!" How many ${artifact} per tribe?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} climbed ${num1} vines in the morning. In the afternoon, ${num2} more vines with ${animal} swinging and shouting "${call}!" How many vines total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} packed ${num1} supplies for the quest. After traps took ${num2} amid "${call}!", how many supplies remained?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} explored ${num1} temples. Each contained ${num2} ${color} ${artifact}, with echoes of "${call}!" How many ${artifact} found?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, animal, color, artifact, call] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${animal} gifted ${num1} ${color} fruits to ${name}. Divided into ${divisor} packs with "${call}!", how many fruits per pack?`;
                        }
                    }
                ]
            },
            // New story structure 4: Time Travel Tales (Time-based theme: traveling through eras, collecting historical items)
            {
                title: "Time Travel Tales with [Name]",
                description: "Jump through time portals to visit different eras, meet historical figures, and collect artifacts from history!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Historical Figure (plural)", type: "text" },
                    { label: "Time Period Color", type: "text" },
                    { label: "Historical Item (plural)", type: "text" },
                    { label: "Time Warp Sound", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} time-traveled and met ${num1} ${color} ${figure}. With a "${sound}!", ${num2} more ${figure} arrived. How many ${figure} total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} collected ${num1} ${item} from the past. The ${figure} borrowed ${num2} amid "${sound}!" How many ${item} left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `${name} visited ${num1} eras. Each era had ${num2} ${color} ${figure}, all echoing "${sound}!" How many ${figure} met?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} gathered ${num1} ${item} to distribute to ${divisor} groups of ${figure}. Each group heard "${sound}!" How many ${item} per group?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} jumped through ${num1} portals in one day. Later, ${num2} more portals with ${figure} calling "${sound}!" How many portals total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} had ${num1} time gadgets. After fixing paradoxes, ${num2} were lost in "${sound}!" How many gadgets remained?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} collected ${num1} sets of ${item}. Each set had ${num2} pieces from ${color} eras, with "${sound}!" How many pieces total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, figure, color, item, sound] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${figure} shared ${num1} ancient ${color} scrolls with ${name}. Divided into ${divisor} timelines with "${sound}!", how many scrolls per timeline?`;
                        }
                    }
                ]
            },
            // New story structure 5: Circus Extravaganza (Performance theme: shows, acts, crowds, and tricks)
            {
                title: "Circus Extravaganza with Ringmaster [Name]",
                description: "Run a spectacular circus with daring acts, funny clowns, and amazing animals under the big top!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Circus Performer (plural)", type: "text" },
                    { label: "Flashy Color", type: "text" },
                    { label: "Circus Prop (plural)", type: "text" },
                    { label: "Crowd Cheer", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} started the circus with ${num1} ${color} ${performer}. The crowd cheered "${cheer}!" Then ${num2} more ${performer} joined. How many ${performer} total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} prepared ${num1} ${prop} for the show. The ${performer} broke ${num2} during tricks amid "${cheer}!" How many ${prop} left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `The circus had ${num1} acts. Each act used ${num2} ${color} ${prop}, with the crowd yelling "${cheer}!" How many ${prop} used?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} won ${num1} tickets from games. Divided among ${divisor} groups of ${performer} with "${cheer}!", how many tickets per group?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} invited ${num1} clowns in the first show. Later, ${num2} more clowns with ${performer} and "${cheer}!" How many clowns total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} sold ${num1} popcorn boxes. After the show, ${num2} were left uneaten amid "${cheer}!" How many sold?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} performed ${num1} tricks. Each trick involved ${num2} ${color} ${prop}, exciting the crowd with "${cheer}!" How many ${prop} used?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, performer, color, prop, cheer] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${performer} shared ${num1} balloons. Divided into ${divisor} tents with "${cheer}!", how many balloons per tent?`;
                        }
                    }
                ]
            },
            // New story structure 6: Wizard's School (Magic/Learning theme: spells, potions, magical creatures, learning magic)
            {
                title: "Wizard's School with Apprentice [Name]",
                description: "Attend a magical school to learn spells, brew potions, and adventure with mystical creatures!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Mystical Creature (plural)", type: "text" },
                    { label: "Enchanted Color", type: "text" },
                    { label: "Potion Ingredient (plural)", type: "text" },
                    { label: "Spell Chant", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} summoned ${num1} ${color} ${creature} in class. With "${chant}!", ${num2} more appeared. How many ${creature} total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} brewed ${num1} potions using ${ingredient}. The ${creature} spilled ${num2} while chanting "${chant}!" How many potions left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `${name} cast ${num1} spells. Each spell required ${num2} ${color} ${ingredient}, with "${chant}!" How many ${ingredient} used?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} gathered ${num1} wands to give to ${divisor} classes of ${creature}. Each class chanted "${chant}!" How many wands per class?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} learned ${num1} charms in the morning. In the afternoon, ${num2} more charms with ${creature} and "${chant}!" How many charms total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} had ${num1} spellbooks. After lending ${num2} to friends amid "${chant}!", how many spellbooks remained?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} mixed ${num1} cauldrons of potion. Each cauldron needed ${num2} ${ingredient}, bubbling with "${chant}!" How many ${ingredient} total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, color, ingredient, chant] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${creature} created ${num1} ${color} orbs. ${name} divided them into ${divisor} towers with "${chant}!" How many orbs per tower?`;
                        }
                    }
                ]
            },
            // New story structure 7: Robot Factory Frenzy (Invention theme: building, repairing, and inventing gadgets with robots)
            {
                title: "Robot Factory Frenzy with Inventor [Name]",
                description: "Build and fix robots in a high-tech factory, inventing gadgets and solving mechanical puzzles!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Robot Type (plural)", type: "text" },
                    { label: "Metallic Color", type: "text" },
                    { label: "Gadget Part (plural)", type: "text" },
                    { label: "Robot Beep", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} assembled ${num1} ${color} ${robot}. They beeped "${beep}!" Then ${num2} more ${robot} were built. How many ${robot} total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} had ${num1} ${part} in the factory. The ${robot} used ${num2} for repairs with "${beep}!" How many ${part} left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `${name} designed ${num1} machines. Each machine had ${num2} ${color} ${part}, beeping "${beep}!" How many ${part} total?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} produced ${num1} batteries to power ${divisor} lines of ${robot}. Each line beeped "${beep}!" How many batteries per line?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} programmed ${num1} circuits in the lab. Later, ${num2} more circuits with ${robot} beeping "${beep}!" How many circuits total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} stocked ${num1} tools. After inventions, ${num2} tools were worn out amid "${beep}!" How many tools remained?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} created ${num1} prototypes. Each prototype used ${num2} ${part}, activating with "${beep}!" How many ${part} used?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, robot, color, part, beep] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${robot} assembled ${num1} ${color} gears. ${name} divided them into ${divisor} robots with "${beep}!" How many gears per robot?`;
                        }
                    }
                ]
            },
            // New story structure 8: Fairy Forest Festival (Celebration theme: festivals, dances, magical events in a forest)
            {
                title: "Fairy Forest Festival with [Name]",
                description: "Join a enchanting festival in the fairy forest with dances, magic, and whimsical creatures!",
                prompts: [
                    { label: "Your Name", type: "text" },
                    { label: "Fairy Creature (plural)", type: "text" },
                    { label: "Magical Color", type: "text" },
                    { label: "Festival Treat (plural)", type: "text" },
                    { label: "Festival Song", type: "text" }
                ],
                problemTemplates: [
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const num1 = random(5, 15);
                            const num2 = random(3, 10);
                            return `${name} arrived at the festival and saw ${num1} ${color} ${creature}. Singing "${song}!", ${num2} more joined. How many ${creature} total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const num1 = random(15, 30);
                            const num2 = random(5, 12);
                            return `${name} baked ${num1} ${treat} for the festival. The ${creature} ate ${num2} while dancing to "${song}!" How many ${treat} left?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const num1 = random(4, 8);
                            const num2 = random(3, 6);
                            return `The festival had ${num1} dances. Each dance involved ${num2} ${color} ${creature}, singing "${song}!" How many ${creature} danced?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const divisor = random(2, 5);
                            const quotient = random(4, 8);
                            const num1 = divisor * quotient;
                            return `${name} prepared ${num1} wishes for ${divisor} glades of ${creature}. Each glade sang "${song}!" How many wishes per glade?`;
                        }
                    },
                    {
                        type: 'addition',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const num1 = random(8, 18);
                            const num2 = random(6, 14);
                            return `${name} decorated ${num1} trees for the festival. Later, ${num2} more trees with ${creature} and "${song}!" How many trees total?`;
                        }
                    },
                    {
                        type: 'subtraction',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const num1 = random(20, 35);
                            const num2 = random(8, 15);
                            return `${name} had ${num1} fairy lights. After the party, ${num2} burned out amid "${song}!" How many lights remained?`;
                        }
                    },
                    {
                        type: 'multiplication',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const num1 = random(5, 9);
                            const num2 = random(3, 7);
                            return `${name} hosted ${num1} games. Each game gave ${num2} ${treat}, with cheers of "${song}!" How many ${treat} given?`;
                        }
                    },
                    {
                        type: 'division',
                        generate: (words) => {
                            const [name, creature, color, treat, song] = words;
                            const divisor = random(3, 6);
                            const quotient = random(5, 8);
                            const num1 = divisor * quotient;
                            return `The ${creature} made ${num1} ${color} flowers. Divided into ${divisor} bouquets with "${song}!", how many flowers per bouquet?`;
                        }
                    }
                ]
            }
        ];

        let currentTemplate;
        let userWords = [];
        let selectedMathType = 'random';

        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Smart emoji selector based on keywords (fixed garbled entries)
        function getEmojiForWord(word) {
            const lowerWord = word.toLowerCase();
            
            // Animal emojis
            const animals = {
                'dog': 'üêï', 'dogs': 'üêï', 'puppy': 'üê∂', 'puppies': 'üê∂',
                'cat': 'üê±', 'cats': 'üê±', 'kitten': 'üê±', 'kittens': 'üê±',
                'bird': 'üê¶', 'birds': 'üê¶',
                'fish': 'üêü', 'fishes': 'üêü',
                'bear': 'üêª', 'bears': 'üêª',
                'lion': 'ü¶Å', 'lions': 'ü¶Å',
                'tiger': 'üêØ', 'tigers': 'üêØ',
                'elephant': 'üêò', 'elephants': 'üêò',
                'monkey': 'üêµ', 'monkeys': 'üêµ',
                'panda': 'üêº', 'pandas': 'üêº',
                'koala': 'üê®', 'koalas': 'üê®',
                'frog': 'üê∏', 'frogs': 'üê∏',
                'pig': 'üê∑', 'pigs': 'üê∑',
                'cow': 'üêÆ', 'cows': 'üêÆ',
                'horse': 'üê¥', 'horses': 'üê¥',
                'unicorn': 'ü¶Ñ', 'unicorns': 'ü¶Ñ',
                'dragon': 'üêâ', 'dragons': 'üêâ',
                'dinosaur': 'ü¶ï', 'dinosaurs': 'ü¶ï', 'dino': 'ü¶ñ', 'dinos': 'ü¶ñ',
                'rabbit': 'üê∞', 'rabbits': 'üê∞', 'bunny': 'üê∞', 'bunnies': 'üê∞',
                'mouse': 'üê≠', 'mice': 'üê≠',
                'hamster': 'üêπ', 'hamsters': 'üêπ',
                'fox': 'ü¶ä', 'foxes': 'ü¶ä',
                'wolf': 'üê∫', 'wolves': 'üê∫',
                'koala': 'üê®', 'koalas': 'üê®',
                'penguin': 'üêß', 'penguins': 'üêß',
                'chicken': 'üêî', 'chickens': 'üêî',
                'duck': 'ü¶Ü', 'ducks': 'ü¶Ü',
                'owl': 'ü¶â', 'owls': 'ü¶â',
                'bee': 'üêù', 'bees': 'üêù',
                'butterfly': 'ü¶ã', 'butterflies': 'ü¶ã',
                'snail': 'üêå', 'snails': 'üêå',
                'bug': 'üêõ', 'bugs': 'üêõ',
                'ant': 'üêú', 'ants': 'üêú',
                'spider': 'üï∑Ô∏è', 'spiders': 'üï∑Ô∏è',
                'turtle': 'üê¢', 'turtles': 'üê¢',
                'snake': 'üêç', 'snakes': 'üêç',
                'lizard': 'ü¶é', 'lizards': 'ü¶é',
                'octopus': 'üêô', 'octopi': 'üêô',
                'squid': 'ü¶ë', 'squids': 'ü¶ë',
                'shrimp': 'ü¶ê', 'shrimps': 'ü¶ê',
                'crab': 'ü¶Ä', 'crabs': 'ü¶Ä',
                'lobster': 'ü¶û', 'lobsters': 'ü¶û',
                'dolphin': 'üê¨', 'dolphins': 'üê¨',
                'whale': 'üêã', 'whales': 'üêã',
                'shark': 'ü¶à', 'sharks': 'ü¶à',
                'seal': 'ü¶≠', 'seals': 'ü¶≠',
                'alien': 'üëΩ', 'aliens': 'üëΩ',
                'robot': 'ü§ñ', 'robots': 'ü§ñ',
                'monster': 'üëπ', 'monsters': 'üëª',
                'zombie': 'üßü', 'zombies': 'üßü',
                'vampire': 'üßõ', 'vampires': 'üßõ',
                'fairy': 'üßö', 'fairies': 'üßö',
                'mermaid': 'üßú', 'mermaids': 'üßú',
                'elf': 'üßù', 'elves': 'üßù',
                'genie': 'üßû', 'genies': 'üßû'
            };
            
            // Food emojis
            const foods = {
                'pizza': 'üçï', 'burger': 'üçî', 'hamburger': 'üçî',
                'hotdog': 'üå≠', 'hot dog': 'üå≠',
                'taco': 'üåÆ', 'tacos': 'üåÆ',
                'burrito': 'üåØ', 'burritos': 'üåØ',
                'sandwich': 'ü•™', 'sandwiches': 'ü•™',
                'cookie': 'üç™', 'cookies': 'üç™',
                'cake': 'üéÇ', 'cakes': 'üéÇ',
                'cupcake': 'üßÅ', 'cupcakes': 'üßÅ',
                'donut': 'üç©', 'donuts': 'üç©', 'doughnut': 'üç©',
                'candy': 'üç¨', 'candies': 'üç¨',
                'lollipop': 'üç≠', 'lollipops': 'üç≠',
                'chocolate': 'üç´',
                'ice cream': 'üç¶', 'icecream': 'üç¶',
                'apple': 'üçé', 'apples': 'üçé',
                'banana': 'üçå', 'bananas': 'üçå',
                'orange': 'üçä', 'oranges': 'üçä',
                'strawberry': 'üçì', 'strawberries': 'üçì',
                'watermelon': 'üçâ',
                'grape': 'üçá', 'grapes': 'üçá',
                'cherry': 'üçí', 'cherries': 'üçí',
                'peach': 'üçë', 'peaches': 'üçë',
                'pineapple': 'üçç', 'pineapples': 'üçç',
                'carrot': 'ü•ï', 'carrots': 'ü•ï',
                'corn': 'üåΩ',
                'bread': 'üçû',
                'pretzel': 'ü•®', 'pretzels': 'ü•®',
                'popcorn': 'üçø',
                'french fries': 'üçü', 'fries': 'üçü',
                'sushi': 'üç£',
                'egg': 'ü•ö', 'eggs': 'ü•ö',
                'bacon': 'ü•ì',
                'cheese': 'üßÄ',
                'milk': 'ü•õ',
                'coffee': '‚òï',
                'tea': 'üçµ',
                'juice': 'üßÉ',
                'soda': 'ü•§',
                'pie': 'ü•ß', 'pies': 'ü•ß'
            };
            
            // Objects & things
            const objects = {
                'star': '‚≠ê', 'stars': '‚≠ê',
                'heart': '‚ù§Ô∏è', 'hearts': '‚ù§Ô∏è',
                'flower': 'üå∏', 'flowers': 'üå∏',
                'rose': 'üåπ', 'roses': 'üåπ',
                'tree': 'üå≥', 'trees': 'üå≥',
                'plant': 'üå±', 'plants': 'üå±',
                'ball': '‚öΩ', 'balls': '‚öΩ',
                'balloon': 'üéà', 'balloons': 'üéà',
                'gift': 'üéÅ', 'gifts': 'üéÅ', 'present': 'üéÅ', 'presents': 'üéÅ',
                'trophy': 'üèÜ', 'trophies': 'üèÜ',
                'medal': 'üèÖ', 'medals': 'üèÖ',
                'crown': 'üëë', 'crowns': 'üëë',
                'gem': 'üíé', 'gems': 'üíé', 'diamond': 'üíé', 'diamonds': 'üíé',
                'crystal': 'üîÆ', 'crystals': 'üîÆ',
                'key': 'üîë', 'keys': 'üîë',
                'coin': 'ü™ô', 'coins': 'ü™ô',
                'money': 'üí∞', 'gold': 'üí∞', 'treasure': 'üí∞',
                'book': 'üìö', 'books': 'üìö',
                'pencil': '‚úèÔ∏è', 'pencils': '‚úèÔ∏è',
                'crayon': 'üñçÔ∏è', 'crayons': 'üñçÔ∏è',
                'paint': 'üé®',
                'music': 'üéµ', 'note': 'üéµ', 'notes': 'üéµ',
                'guitar': 'üé∏', 'guitars': 'üé∏',
                'drum': 'ü•Å', 'drums': 'ü•Å',
                'trumpet': 'üé∫', 'trumpets': 'üé∫',
                'microphone': 'üé§', 'mic': 'üé§',
                'camera': 'üì∑', 'cameras': 'üì∑',
                'phone': 'üì±', 'phones': 'üì±',
                'computer': 'üíª', 'computers': 'üíª',
                'watch': '‚åö', 'watches': '‚åö',
                'clock': 'üïê', 'clocks': 'üïê',
                'bell': 'üîî', 'bells': 'üîî',
                'lightbulb': 'üí°', 'light': 'üí°',
                'candle': 'üïØÔ∏è', 'candles': 'üïØÔ∏è',
                'fire': 'üî•',
                'sun': '‚òÄÔ∏è',
                'moon': 'üåô',
                'cloud': '‚òÅÔ∏è', 'clouds': '‚òÅÔ∏è',
                'rainbow': 'üåà', 'rainbows': 'üåà',
                'snowflake': '‚ùÑÔ∏è', 'snow': '‚ùÑÔ∏è',
                'umbrella': '‚òÇÔ∏è', 'umbrellas': '‚òÇÔ∏è',
                'rocket': 'üöÄ', 'rockets': 'üöÄ',
                'airplane': '‚úàÔ∏è', 'plane': '‚úàÔ∏è', 'planes': '‚úàÔ∏è',
                'car': 'üöó', 'cars': 'üöó',
                'bus': 'üöå', 'buses': 'üöå',
                'train': 'üöÇ', 'trains': 'üöÇ',
                'bike': 'üö≤', 'bicycle': 'üö≤', 'bikes': 'üö≤',
                'scooter': 'üõ¥', 'scooters': 'üõ¥',
                'skateboard': 'üõπ', 'skateboards': 'üõπ',
                'boat': '‚õµ', 'boats': '‚õµ', 'ship': 'üö¢', 'ships': 'üö¢',
                'helicopter': 'üöÅ', 'helicopters': 'üöÅ',
                'house': 'üè†', 'houses': 'üè†', 'home': 'üè†',
                'castle': 'üè∞', 'castles': 'üè∞',
                'tent': '‚õ∫', 'tents': '‚õ∫',
                'mountain': '‚õ∞Ô∏è', 'mountains': '‚õ∞Ô∏è',
                'volcano': 'üåã', 'volcanoes': 'üåã',
                'island': 'üèùÔ∏è', 'islands': 'üèùÔ∏è',
                'beach': 'üèñÔ∏è',
                'desert': 'üèúÔ∏è',
                'forest': 'üå≤',
                'cactus': 'üåµ',
                'mushroom': 'üçÑ', 'mushrooms': 'üçÑ',
                'map': 'üó∫Ô∏è', 'maps': 'üó∫Ô∏è',
                'compass': 'üß≠',
                'backpack': 'üéí', 'backpacks': 'üéí',
                'tent': '‚õ∫', 'tents': '‚õ∫'
            };
            
            // Activities & places
            const activities = {
                'soccer': '‚öΩ', 'football': 'üèà',
                'basketball': 'üèÄ',
                'baseball': '‚öæ',
                'tennis': 'üéæ',
                'volleyball': 'üèê',
                'bowling': 'üé≥',
                'game': 'üéÆ', 'games': 'üéÆ', 'gaming': 'üéÆ',
                'puzzle': 'üß©', 'puzzles': 'üß©',
                'magic': '‚ú®', 'magical': '‚ú®', 'sparkle': '‚ú®',
                'party': 'üéâ', 'parties': 'üéâ', 'celebration': 'üéä',
                'birthday': 'üéÇ',
                'carnival': 'üé™', 'circus': 'üé™',
                'ferris wheel': 'üé°',
                'roller coaster': 'üé¢',
                'carousel': 'üé†',
                'ticket': 'üé´', 'tickets': 'üé´',
                'art': 'üé®', 'painting': 'üé®',
                'school': 'üè´', 'academy': 'üè´',
                'park': 'üå≥',
                'playground': 'üé†',
                'zoo': 'ü¶Å',
                'farm': 'üöú',
                'space': 'üåå', 'galaxy': 'üåå',
                'planet': 'ü™ê', 'planets': 'ü™ê',
                'earth': 'üåç',
                'mars': 'üî¥',
                'jupiter': 'ü™ê',
                'pirate': 'üè¥‚Äç‚ò†Ô∏è', 'pirates': 'üè¥‚Äç‚ò†Ô∏è',
                'superhero': 'ü¶∏', 'superheroes': 'ü¶∏', 'hero': 'ü¶∏', 'heroes': 'ü¶∏',
                'villain': 'ü¶π', 'villains': 'ü¶π',
                'power': '‚ö°', 'powers': '‚ö°', 'lightning': '‚ö°',
                'shield': 'üõ°Ô∏è', 'shields': 'üõ°Ô∏è'
            };
            
            // Check all categories
            if (animals[lowerWord]) return animals[lowerWord];
            if (foods[lowerWord]) return foods[lowerWord];
            if (objects[lowerWord]) return objects[lowerWord];
            if (activities[lowerWord]) return activities[lowerWord];
            
            // Fallback to generic emojis
            return '‚ú®';
        }

        // Custom image generator using Canvas API
        function generateCustomImage(words, problemIndex, problemText) {
            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            
            // Get relevant emoji from user's words
            const emoji = getRelevantEmoji(words, currentTemplate.title);
            
            // Create gradient backgrounds with different colors
            const gradients = [
                ['#667eea', '#764ba2'], // Purple
                ['#f093fb', '#f5576c'], // Pink
                ['#4facfe', '#00f2fe'], // Blue
                ['#43e97b', '#38f9d7'], // Green
                ['#fa709a', '#fee140'], // Orange/Pink
                ['#30cfd0', '#330867'], // Teal/Purple
                ['#a8edea', '#fed6e3'], // Pastel
                ['#ff9a9e', '#fecfef'], // Light Pink
            ];
            
            const colorPair = gradients[problemIndex % gradients.length];
            const gradient = ctx.createLinearGradient(0, 0, 300, 300);
            gradient.addColorStop(0, colorPair[0]);
            gradient.addColorStop(1, colorPair[1]);
            
            // Fill background with gradient
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 300, 300);
            
            // Add subtle pattern/shapes in background
            ctx.globalAlpha = 0.1;
            ctx.fillStyle = 'white';
            for (let i = 0; i < 5; i++) {
                const x = Math.random() * 300;
                const y = Math.random() * 300;
                const size = Math.random() * 100 + 50;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1.0;
            
            // Draw main emoji (large)
            ctx.font = '120px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Add shadow for emoji
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 3;
            ctx.shadowOffsetY = 3;
            
            ctx.fillText(emoji, 150, 150);
            
            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            
            // Add decorative smaller emojis
            ctx.font = '40px Arial';
            const corners = [
                {x: 40, y: 40},
                {x: 260, y: 40},
                {x: 40, y: 260},
                {x: 260, y: 260}
            ];
            
            corners.forEach((corner, i) => {
                ctx.globalAlpha = 0.4;
                ctx.fillText(emoji, corner.x, corner.y);
            });
            ctx.globalAlpha = 1.0;
            
            // Add problem number badge at top
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.beginPath();
            ctx.roundRect(110, 10, 80, 35, 17.5);
            ctx.fill();
            
            ctx.fillStyle = colorPair[0];
            ctx.font = 'bold 20px Arial';
            ctx.fillText(`#${problemIndex + 1}`, 150, 30);
            
            // Convert canvas to data URL
            return canvas.toDataURL('image/png');
        }

        // Alternative: Simpler design with just emoji and clean background (default for robustness)
        function generateSimpleImage(words, problemIndex) {
            const canvas = document.createElement('canvas');
            canvas.width = 250;
            canvas.height = 250;
            const ctx = canvas.getContext('2d');
            
            // Get relevant emoji
            const emoji = getRelevantEmoji(words, currentTemplate.title);
            
            // Solid pastel backgrounds
            const backgrounds = [
                '#E3F2FD', // Light Blue
                '#F3E5F5', // Light Purple
                '#FFF3E0', // Light Orange
                '#E8F5E9', // Light Green
                '#FCE4EC', // Light Pink
                '#F1F8E9', // Light Lime
                '#FFF9C4', // Light Yellow
                '#FFEBEE'  // Light Red
            ];
            
            const bgColor = backgrounds[problemIndex % backgrounds.length];
            
            // Fill background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, 250, 250);
            
            // Draw circular background for emoji
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(125, 125, 90, 0, Math.PI * 2);
            ctx.fill();
            
            // Add subtle shadow to circle
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Draw emoji
            ctx.font = '100px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, 125, 135);
            
            return canvas.toDataURL('image/png');
        }

        // Fun meme-style with caption (for better story representation using problemText)
        function generateMemeStyleImage(words, problemIndex, caption) {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // Get relevant emoji
            const emoji = getRelevantEmoji(words, currentTemplate.title);
            
            // Bright, fun colors
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
                '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'
            ];
            
            const bgColor = colors[problemIndex % colors.length];
            
            // Fill background
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, 400, 400);
            
            // Add border
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 8;
            ctx.strokeRect(0, 0, 400, 400);
            
            // Draw emoji
            ctx.font = '150px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // White outline for emoji
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 8;
            ctx.strokeText(emoji, 200, 200);
            
            ctx.fillText(emoji, 200, 200);
            
            // Add caption at bottom if provided (extract short phrase from problemText for better representation)
            if (caption) {
                // White background for text
                ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.fillRect(0, 320, 400, 80);
                
                // Caption text
                ctx.fillStyle = '#333';
                ctx.font = 'bold 24px Impact, Arial';
                ctx.textAlign = 'center';
                
                // Word wrap caption
                const maxWidth = 360;
                const words = caption.split(' ');
                let line = '';
                let y = 345;
                
                words.forEach(word => {
                    const testLine = line + word + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && line !== '') {
                        ctx.fillText(line.trim(), 200, y);
                        line = word + ' ';
                        y += 30;
                    } else {
                        line = testLine;
                    }
                });
                ctx.fillText(line.trim(), 200, y);
            }
            
            return canvas.toDataURL('image/png');
        }

        // Helper function to generate thematic images based on user's words (made more robust with try-catch)
        function generateImageUrl(storyTitle, words, problemIndex, problemText = '') {
            try {
                // Extract a short caption from problemText for better story rep (first 5 words or so)
                const caption = problemText.split(' ').slice(0, 5).join(' ') + '...';
                
                // Use meme style for better representation
                return generateMemeStyleImage(words, problemIndex, caption);
            } catch (e) {
                console.error('Error generating custom image:', e);
                
                // Fallback to simple emoji image
                return generateSimpleImage(words, problemIndex);
            }
        }

        // Get the most relevant emoji from user's words
        function getRelevantEmoji(words, storyTitle) {
            // Try each word to find a matching emoji
            for (let word of words) {
                const emoji = getEmojiForWord(word);
                if (emoji !== '‚ú®') { // If we found a specific emoji (not fallback)
                    return emoji;
                }
            }
            
            // Story-specific fallbacks
            if (storyTitle.includes('Parade')) return 'üé™';
            if (storyTitle.includes('Space')) return 'üöÄ';
            if (storyTitle.includes('Bakery')) return 'üßÅ';
            if (storyTitle.includes('Carnival')) return 'üé°';
            if (storyTitle.includes('Pirate')) return 'üè¥‚Äç‚ò†Ô∏è';
            if (storyTitle.includes('Dinosaur')) return 'ü¶ï';
            if (storyTitle.includes('Superhero')) return 'ü¶∏';
            if (storyTitle.includes('Underwater')) return 'üåä';
            if (storyTitle.includes('Farmyard')) return 'üöú';
            if (storyTitle.includes('Jungle')) return 'üåø';
            if (storyTitle.includes('Time Travel')) return '‚è≥';
            if (storyTitle.includes('Circus')) return 'üé™';
            if (storyTitle.includes('Wizard')) return 'ü™Ñ';
            if (storyTitle.includes('Robot')) return 'ü§ñ';
            if (storyTitle.includes('Fairy')) return 'üßö';
            
            return '‚ú®'; // Final fallback
        }

        function initializeMadLibs() {
            // Pick a random template
            currentTemplate = storyTemplates[Math.floor(Math.random() * storyTemplates.length)];
            
            // Update story preview
            updateStoryPreview();
            
            // Create form inputs
            const form = document.getElementById('madLibsForm');
            form.innerHTML = '';
            
            currentTemplate.prompts.forEach((prompt, index) => {
                const div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `
                    <label for="word${index}">${prompt.label}:</label>
                    <input type="text" id="word${index}" required>
                `;
                form.appendChild(div);
            });
        }

        function updateStoryPreview() {
            document.getElementById('storyTitle').textContent = currentTemplate.title;
            document.getElementById('storyDescription').textContent = currentTemplate.description;
        }

        function refreshStory() {
            // Pick a different random template (ensures variety)
            const oldTemplate = currentTemplate;
            do {
                currentTemplate = storyTemplates[Math.floor(Math.random() * storyTemplates.length)];
            } while (storyTemplates.length > 1 && currentTemplate === oldTemplate);
            
            // Update the preview and form
            updateStoryPreview();
            
            // Recreate form inputs
            const form = document.getElementById('madLibsForm');
            form.innerHTML = '';
            
            currentTemplate.prompts.forEach((prompt, index) => {
                const div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `
                    <label for="word${index}">${prompt.label}:</label>
                    <input type="text" id="word${index}" required>
                `;
                form.appendChild(div);
            });
        }

        function generateWorksheet() {
            // Get selected math type from dropdown
            selectedMathType = document.getElementById('mathTypeSelect').value;
            
            // Collect user inputs
            userWords = [];
            let allFilled = true;
            
            currentTemplate.prompts.forEach((prompt, index) => {
                const input = document.getElementById(`word${index}`);
                const value = input.value.trim();
                if (value === '') {
                    allFilled = false;
                }
                userWords.push(value || 'blank');
            });

            if (!allFilled) {
                alert('Please fill in all the blanks! üòä');
                return;
            }

            // Generate problems (cap at 5 for worksheet, but use all available for variety in selection)
            let selectedProblems = [];
            
            if (selectedMathType === 'random') {
                // Shuffle all problem templates for random mix
                const allTemplates = shuffleArray([...currentTemplate.problemTemplates]);
                
                // Pick up to 5 unique ones
                const numProblems = Math.min(5, allTemplates.length);
                for (let i = 0; i < numProblems; i++) {
                    const template = allTemplates[i];
                    selectedProblems.push({ 
                        text: template.generate(userWords), 
                        type: template.type,
                        imageUrl: generateImageUrl(currentTemplate.title, userWords, i, selectedProblems.text)
                    });
                }
            } else {
                // Filter by specific type
                const typeTemplates = currentTemplate.problemTemplates.filter(t => t.type === selectedMathType);
                
                if (typeTemplates.length === 0) {
                    alert(`No ${selectedMathType} problems available for this story. Try selecting "Random Mix"!`);
                    return;
                }
                
                // Shuffle for variety
                const shuffledTemplates = shuffleArray([...typeTemplates]);
                
                // Generate 5, repeating if necessary
                for (let i = 0; i < 5; i++) {
                    const template = shuffledTemplates[i % shuffledTemplates.length];
                    selectedProblems.push({ 
                        text: template.generate(userWords), 
                        type: template.type,
                        imageUrl: generateImageUrl(currentTemplate.title, userWords, i, selectedProblems.text)
                    });
                }
            }

            // Render worksheet
            const content = document.getElementById('worksheetContent');
            content.innerHTML = '';

            selectedProblems.forEach((problem, index) => {
                const div = document.createElement('div');
                div.className = 'story-problem';
                
                // Get a relevant emoji from the user's words
                const relevantEmoji = getRelevantEmoji(userWords, currentTemplate.title);
                
                let imageHtml = '';
                if (problem.imageUrl) {
                    imageHtml = `
                        <img 
                            src="${problem.imageUrl}" 
                            alt="Problem illustration" 
                            class="problem-image"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        >
                        <div class="problem-image-error" style="display: none;">${relevantEmoji}</div>
                    `;
                }
                
            div.innerHTML = `
                <div class="problem-number">Problem ${index + 1}:</div>
                ${imageHtml}
                <div class="problem-text">${problem.text}</div>
                <div class="answer-line">
                    <span class="answer-label">Answer:</span>
                    <span class="answer-space" style="min-width: 50px; margin-right: 10px;"></span>
                    ( <span class="answer-space" style="min-width: 30px; margin: 0 10px;"></span> )
                    <span class="answer-space" style="min-width: 50px; margin: 0 10px;"></span>
                    = <span class="answer-space" style="min-width: 50px; margin-left: 10px;"></span>
                </div>
            `;
                content.appendChild(div);
            });

            // Update worksheet title with the story title, replacing placeholders
            let storyTitle = currentTemplate.title.replace('[Name]', userWords[0]);
            document.querySelector('.worksheet-title').textContent = storyTitle;

            // Show worksheet, hide form
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('worksheet').classList.add('active');
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function printWorksheet() {
            window.print();
        }

        function startOver() {
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('worksheet').classList.remove('active');
            initializeMadLibs();
            
            // Clear previous inputs
            currentTemplate.prompts.forEach((prompt, index) => {
                document.getElementById(`word${index}`).value = '';
            });
        }

        // Initialize on page load
        window.onload = initializeMadLibs;
    </script>
</body>
</html>