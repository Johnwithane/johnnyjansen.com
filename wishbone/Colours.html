<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishbone Interactive Catalog - Condensed</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/geometries/RoundedBoxGeometry.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            margin: 0; 
            overflow-x: hidden; 
        }

        /* 3D Canvas Layers */
        #c { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 40; pointer-events: none; display: block; background: transparent; }
        #c-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 110; pointer-events: none; display: block; background: transparent; }

        /* Modal Overlay */
        #editor-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #editor-modal.active { display: flex; }

        /* Page Layout - Screen View */
        .page-sheet { 
            background: white; 
            width: 210mm; 
            min-height: 275mm; 
            margin: 20px auto; 
            padding: 10mm 15mm; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            position: relative; 
            /* Added for footer positioning */
            display: flex;
            flex-direction: column;
        }
        
        /* Spacing between categories on the same page */
        .category-block { margin-bottom: 2rem; }

        /* 3D Item Containers */
        .scene-element { width: 100%; aspect-ratio: 1 / 1; position: relative; cursor: grab; touch-action: none; z-index: 20; }
        .scene-element:active { cursor: grabbing; }
        .print-image { display: none; width: 100%; height: 100%; object-fit: contain; }

        /* UI Controls (Hover Buttons) */
        .item-controls { opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 50; }
        .group:hover .item-controls { opacity: 1; }
        .control-btn { pointer-events: auto; background: white; color: #4B5563; border-radius: 9999px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; font-size: 10px; }
        .control-btn:hover { background: #2563EB; color: white; transform: scale(1.1); }
        .control-btn.btn-delete:hover { background: #EF4444; color: white; }

        /* Form Elements Styles */
        input[type=range] { width: 100%; accent-color: #4B5563; cursor: pointer; }
        select, input[type=text], input[type=color] { border: 1px solid #e5e7eb; border-radius: 0.375rem; }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }
        
        /* Advanced Panel Animation */
        .advanced-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .advanced-panel.open { max-height: 500px; overflow-y: auto; }

        /* Print Logic (PDF Generation) */
        @media print {
            @page { margin: 0; size: auto; }
            body { 
                background: white; 
                margin: 0;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .no-print, #c, #c-modal { display: none !important; }
            
            /* The Sheet becomes the page */
            .page-sheet { 
                margin: 0; 
                width: 100%; 
                height: 100%; 
                box-shadow: none; 
                padding: 10mm 15mm 5mm; 
                overflow: hidden; 
                page-break-after: always;
                /* Added for footer positioning */
                display: flex !important;
                flex-direction: column !important;
            }
            /* Last page shouldn't force a blank page after it */
            .page-sheet:last-child { page-break-after: auto; }
            
            .print-image { 
                display: block !important; 
                position: absolute;           
                top: 50%;                     
                left: 50%;                    
                transform: translate(-50%, -50%); 
                width: 135%;                
                height: 135%;               
                max-width: none;              
                object-fit: contain;          
                z-index: 50;                  
            }

            .scene-element, .add-card, .item-controls { display: none !important; }
            .page-break-avoid { break-inside: avoid; }
        }
    </style>
</head>
<body>

    <canvas id="c"></canvas>
    <canvas id="c-modal"></canvas>

    <div class="no-print fixed top-4 right-4 z-50 flex gap-2 flex-col items-end">
        <div class="relative">
            <button onclick="togglePrintMenu()" class="bg-[#213f7d] hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition flex items-center gap-2">
                <i class="fas fa-print"></i> Print PDF <i class="fas fa-chevron-down text-xs ml-1"></i>
            </button>
            <div id="print-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-50 overflow-hidden border border-gray-100">
                <button onclick="prepareAndPrint('high')" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 hover:text-[#213f7d] font-medium border-b border-gray-100 transition">
                    High Quality (PNG)
                </button>
                <button onclick="prepareAndPrint('normal')" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 hover:text-[#213f7d] font-medium transition">
                    Normal (WebP)
                </button>
            </div>
        </div>
        <!-- <button onclick="downloadHTML()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition flex items-center gap-2 text-sm">
            <i class="fas fa-download"></i> Download HTML
        </button> -->

        <button onclick="copyHTMLCode()" class="mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition flex items-center gap-2 text-sm">
            <i class="fas fa-code"></i> Copy Code
        </button>
    </div>

    <div id="content-anchor"></div>

    <div id="editor-modal" class="no-print">
        <div class="bg-white rounded-xl shadow-2xl w-[900px] max-w-[95vw] h-[85vh] flex overflow-hidden">
            
            <div class="w-1/2 bg-gray-100 relative flex flex-col justify-center items-center border-r border-gray-200">
                <div class="absolute top-4 left-4 text-xs font-bold text-[#828282] uppercase tracking-widest">Live Preview</div>
                
                <div class="absolute top-4 right-4 z-50 bg-white/80 backdrop-blur px-3 py-1.5 rounded-full shadow-sm border border-gray-200 flex items-center gap-2">
                    <input type="checkbox" id="save-angle-check" class="cursor-pointer accent-blue-600 w-4 h-4">
                    <label for="save-angle-check" class="text-xs font-bold text-[#828282] cursor-pointer select-none">Sync Angle</label>
                </div>

                <div id="modal-scene-target" class="w-full aspect-square relative z-50 cursor-grab active:cursor-grabbing"></div>
                <div class="absolute bottom-4 text-xs text-[#828282] text-center w-full px-4">
                    Left Click: Rotate Object <br> 
                    (Toggle 'Sync Angle' to save changes to all items)
                </div>
            </div>

            <div class="w-1/2 p-6 overflow-y-auto flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-[#828282]">Edit Material</h2>
                    <button onclick="cancelEdit()" class="text-[#828282] hover:text-[#828282] transition">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>

                <div id="modal-controls" class="space-y-5 flex-1">
                    </div>

                <div class="border-t pt-4 mt-4 flex justify-between items-center">
                    <button onclick="deleteCurrentItem()" class="text-red-500 hover:text-red-700 text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <div class="flex gap-2">                        
                        <button onclick="cancelEdit()" class="bg-gray-100 hover:bg-gray-200 text-[#828282] font-bold py-2 px-4 rounded transition">
                            Cancel
                        </button>
                        <button onclick="saveAndCloseModal()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-6 rounded transition">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // ============================ CONFIGURATION ==============================
        // =========================================================================
        
        const GLOBAL_ENV_URL = 'https://cdn.polyhaven.com/asset_img/primary/citrus_orchard_puresky.png'; 
        const currentYear = new Date().getFullYear(); 

        const COMPANY_INFO = {
            title: "Wishbone Site Furnishings",
            subtitle: `${currentYear} COLOUR & MATERIAL GUIDE`, 
            contact: "WishboneLtd.com | sales@wishboneltd.com | (866) 626-0476",
            logoUrl: "https://wishboneltd.com/templates/yootheme/cache/5e/Wishbone-site-furnishings-80-5e794194.webp"
        };

        const MATERIAL_LIBRARY = {
            wood: ['wood-accoya', 'wood-redCedar', 'bamboo-dark', 'bamboo-light'],
            plastic: ['plastic-black', 'plastic-grey', 'plastic-redwood', 'plastic-walnut', 'plastic-sand'],
            metal: ['metal-oilBronze', 'metal-pewter', 'metal01', 'metal02', 'metal03', 'metal04', 'metal05', 'metal06', 'metal07', 'metal08', 'metal09', 'metal10', 'metal11', 'metal12', 'metal13', 'metal14', 'metal15', 'metal16', 'metal17', 'metal19']
        };
        const SUFFIXES = {
            map: '_Color.jpg',
            bumpMap: '_Displacement.jpg',
            metalnessMap: '_Metalness.jpg',
            normalMap: '_NormalGL.jpg',
            roughnessMap: '_Roughness.jpg'
        };

        // Persistence for sync toggles
        const SYNC_STATE = {
            material: false,
            physics: false,
            filters: false
        };


        
        // -- DATA_START --
let CATEGORIES = [
    {
        "id": 1,
        "title": "Gloss Powders",
        "section": "POWDER colours",
        "subheadingDescriptions": {
            "": ""
        },
        "type": "metal",
        "description": "Smooth, shiny surfaces with bold and bright colours.",
        "items": [
            {
                "id": 106,
                "name": "Sky Blue",
                "subheading": "",
                "color": "#0064c2",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 1.3,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1
            },
            {
                "id": 108,
                "name": "Water Blue",
                "subheading": "",
                "color": "#007e8f",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.9,
                "contrast": 1.3,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 0.7
            },
            {
                "id": 110,
                "name": "Moss Green",
                "subheading": "",
                "color": "#2e4838",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.9,
                "contrast": 1.5,
                "overrides": {
                    "map": "BLANK"
                },
                "bumpScale": 2.3,
                "saturation": 0.7
            },
            {
                "id": 103,
                "name": "Yellow Green",
                "subheading": "",
                "color": "#58b04c",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 1.3,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.8
            },
            {
                "id": 105,
                "name": "Traffic Yellow",
                "subheading": "",
                "color": "#fec701",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.9,
                "contrast": 1.2,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.8
            },
            {
                "id": 107,
                "name": "Pastel Orange",
                "subheading": "",
                "color": "#fe714d",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.9,
                "contrast": 1.6,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.5
            },
            {
                "id": 109,
                "name": "Flame Red",
                "subheading": "",
                "color": "#d32222",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 1.3,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.1
            },
            {
                "id": 102,
                "name": "Hot Pink",
                "subheading": "",
                "color": "#dc3254",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1.4,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1
            },
            {
                "id": 104,
                "name": "Signal Violet",
                "subheading": "",
                "color": "#a24a90",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.6,
                "contrast": 1.2,
                "overrides": {
                    "map": "BLANK"
                },
                "bumpScale": 1.9,
                "saturation": 0.9
            },
            {
                "id": 101,
                "name": "Ultramarine Blue",
                "subheading": "",
                "color": "#1b3780",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.6,
                "materialSet": "metal/metal09",
                "textureScale": 0.1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 1.3,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 0.7
            }
        ]
    },
    {
        "id": 2,
        "title": "Low Lustre Powders",
        "section": "POWDER colours",
        "subheadingDescriptions": {
            "": ""
        },
        "type": "metal",
        "description": "Smooth, easy to clean surfaces that resist fingerprints.",
        "items": [
            {
                "id": 204,
                "name": "Carbon Black",
                "subheading": "",
                "color": "#000000",
                "shape": "cube",
                "roughness": 0.7,
                "metalness": 0.65,
                "materialSet": "metal/metal09",
                "textureScale": 2.5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.5,
                "contrast": 1.1,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.6
            },
            {
                "id": 206,
                "name": "Rideau Brown",
                "subheading": "",
                "color": "#171311",
                "shape": "cube",
                "roughness": 0.7,
                "metalness": 0.45,
                "materialSet": "metal/metal17",
                "bumpScale": 2.3,
                "textureScale": 0.6,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 1,
                "overrides": {
                    "map": "BLANK"
                },
                "saturation": 0.6
            },
            {
                "id": 202,
                "name": "Gun Metal",
                "subheading": "",
                "color": "#ffffff",
                "shape": "cube",
                "roughness": 0.75,
                "metalness": 1,
                "materialSet": "metal/metal05",
                "bumpScale": 0,
                "textureScale": 0.5,
                "textureRotation": 0,
                "textureOffsetX": -0.08,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 0.7,
                "tintLevel": 1,
                "overrides": {
                    "metalnessMap": "BLANK"
                },
                "saturation": 0.8
            },
            {
                "id": 205,
                "name": "Tile Blue",
                "subheading": "",
                "color": "#4c8694",
                "shape": "cube",
                "roughness": 0.5,
                "metalness": 0.5,
                "materialSet": "metal/metal01",
                "textureScale": 0.5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1.1,
                "saturation": 0.8,
                "overrides": {
                    "map": "BLANK",
                    "roughnessMap": "BLANK"
                },
                "bumpScale": 1.1
            },
            {
                "id": 1768251501779,
                "name": "Smoky Grey",
                "subheading": "",
                "color": "#89927c",
                "shape": "cube",
                "roughness": 0.5,
                "metalness": 0.2,
                "materialSet": "metal/metal01",
                "textureScale": 0.5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 1.8,
                "saturation": 1.5,
                "overrides": {
                    "map": "BLANK",
                    "roughnessMap": "BLANK"
                },
                "bumpScale": 1.1
            },
            {
                "id": 1768252033210,
                "name": "Beige",
                "subheading": "",
                "color": "#f7c987",
                "shape": "cube",
                "roughness": 0.7,
                "metalness": 0.65,
                "materialSet": "metal/metal09",
                "textureScale": 2.5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1.4,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.5
            },
            {
                "id": 1768251608897,
                "name": "Night Blue",
                "subheading": "",
                "color": "#191c4e",
                "shape": "cube",
                "roughness": 0.7,
                "metalness": 0.65,
                "materialSet": "metal/metal09",
                "textureScale": 2.5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.5,
                "contrast": 1.1,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.6
            },
            {
                "id": 1768250941958,
                "name": "New York Green",
                "subheading": "",
                "color": "#365439",
                "shape": "cube",
                "roughness": 0.7,
                "metalness": 0.65,
                "materialSet": "metal/metal09",
                "textureScale": 2.5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.5,
                "contrast": 1.1,
                "overrides": {},
                "bumpScale": 3,
                "saturation": 1.6
            }
        ]
    },
    {
        "id": 3,
        "title": "Textured Powders",
        "section": "POWDER colours",
        "subheadingDescriptions": {
            "": ""
        },
        "type": "metal",
        "description": "Fine or coarse textures that help hide blemishes and scratches.",
        "items": [
            {
                "id": 1768249254152,
                "name": "Textured Black",
                "subheading": "",
                "color": "#000000",
                "shape": "cube",
                "roughness": 0.45,
                "metalness": 0.2,
                "materialSet": "metal/metal02",
                "bumpScale": 1.1,
                "textureScale": 1.3,
                "textureRotation": 0,
                "textureOffsetX": -0.45,
                "textureOffsetY": 0.83,
                "brightness": 1,
                "contrast": 1,
                "overrides": {}
            },
            {
                "id": 1768252956357,
                "name": "Oil Rubbed Bronze",
                "subheading": "",
                "color": "#724e31",
                "shape": "cube",
                "roughness": 0.65,
                "metalness": 0.45,
                "materialSet": "metal/metal17",
                "bumpScale": 1.2,
                "textureScale": 0.7,
                "textureRotation": 1,
                "textureOffsetX": 1,
                "textureOffsetY": 0,
                "brightness": 1.3,
                "contrast": 1.1,
                "overrides": {
                    "metalnessMap": "BLANK",
                    "map": "metal/metal-oilBronze"
                },
                "saturation": 1.3,
                "tintLevel": 0
            },
            {
                "id": 1768249691309,
                "name": "Victor Ridge",
                "subheading": "",
                "color": "#000000",
                "shape": "cube",
                "roughness": 0.85,
                "metalness": 0.8,
                "materialSet": "metal/metal17",
                "bumpScale": 2.1,
                "textureScale": 0.6,
                "textureRotation": 9,
                "textureOffsetX": 1,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1,
                "overrides": {
                    "map": "BLANK"
                },
                "tintLevel": 1
            },
            {
                "id": 1768258802260,
                "name": "Textured Silver",
                "subheading": "",
                "color": "#737373",
                "shape": "cube",
                "roughness": 0.55,
                "metalness": 1,
                "materialSet": "metal/metal17",
                "bumpScale": 3,
                "textureScale": 0.7,
                "textureRotation": 1,
                "textureOffsetX": 0.57,
                "textureOffsetY": 0,
                "brightness": 0.7,
                "contrast": 1.5,
                "overrides": {
                    "map": "BLANK",
                    "bumpMap": "BLANK",
                    "metalnessMap": "metal/metal01"
                },
                "saturation": 1.6
            },
            {
                "id": 310,
                "name": "Textured White",
                "subheading": "",
                "color": "#F5F5F5",
                "shape": "cube",
                "roughness": 0.4,
                "metalness": 0.8,
                "materialSet": "metal/metal02",
                "bumpScale": 1.8,
                "textureScale": 1.5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1,
                "overrides": {
                    "map": "BLANK"
                }
            },
            {
                "id": 211,
                "name": "Pewter",
                "subheading": "",
                "color": "#6a6e72",
                "shape": "cube",
                "roughness": 0.15,
                "metalness": 1,
                "materialSet": "metal/metal-pewter",
                "bumpScale": 0.8,
                "textureScale": 1.4,
                "textureRotation": 0,
                "textureOffsetX": 0.68,
                "textureOffsetY": 0.58,
                "brightness": 0.8,
                "contrast": 1,
                "overrides": {},
                "tintLevel": 0,
                "saturation": 0
            },
            {
                "id": 1768258645992,
                "name": "Quartz",
                "subheading": "",
                "color": "#5d5e50",
                "shape": "cube",
                "roughness": 0.8,
                "metalness": 0.4,
                "materialSet": "metal/metal17",
                "bumpScale": 3,
                "textureScale": 0.7,
                "textureRotation": 1,
                "textureOffsetX": 1,
                "textureOffsetY": 0,
                "brightness": 0.7,
                "contrast": 1.5,
                "overrides": {
                    "map": "BLANK",
                    "bumpMap": "BLANK"
                },
                "saturation": 1.6
            },
            {
                "id": 1768252535094,
                "name": "Cactus Green",
                "subheading": "",
                "color": "#595e46",
                "shape": "cube",
                "roughness": 0.8,
                "metalness": 0.4,
                "materialSet": "metal/metal17",
                "bumpScale": 3,
                "textureScale": 0.7,
                "textureRotation": 1,
                "textureOffsetX": 1,
                "textureOffsetY": 0,
                "brightness": 0.7,
                "contrast": 1.5,
                "overrides": {
                    "map": "BLANK",
                    "bumpMap": "BLANK"
                },
                "saturation": 1.6
            },
            {
                "id": 212,
                "name": "Blue Ash",
                "subheading": "",
                "color": "#496969",
                "shape": "cube",
                "roughness": 0.35,
                "metalness": 0.2,
                "materialSet": "metal/metal02",
                "bumpScale": 0.5,
                "textureScale": 5,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1,
                "overrides": {
                    "map": "BLANK"
                }
            }
        ]
    },
    {
        "id": 4,
        "title": "Recycled Plastic",
        "section": "LUMBER colours",
        "type": "plastic",
        "description": "Non-toxic, ultra-durable, low maintenance. 100% recycled.",
        "items": [
            {
                "id": 401,
                "name": "Black",
                "color": "#222222",
                "shape": "plank",
                "roughness": 0.85,
                "metalness": 0.1,
                "materialSet": "plastic/plastic-black",
                "bumpScale": 3,
                "textureScale": 1.4,
                "textureRotation": 0,
                "textureOffsetX": -0.65,
                "textureOffsetY": -0.76,
                "brightness": 0.5,
                "contrast": 1,
                "tintLevel": 0,
                "overrides": {}
            },
            {
                "id": 405,
                "name": "Walnut",
                "color": "#5C4033",
                "shape": "plank",
                "roughness": 0.8,
                "metalness": 0.1,
                "materialSet": "plastic/plastic-walnut",
                "bumpScale": 0.4,
                "textureScale": 1,
                "textureRotation": 0,
                "textureOffsetX": 1,
                "textureOffsetY": -1,
                "brightness": 0.5,
                "contrast": 1,
                "overrides": {},
                "tintLevel": 0
            },
            {
                "id": 402,
                "name": "Grey",
                "color": "#777777",
                "shape": "plank",
                "roughness": 0.85,
                "metalness": 0.1,
                "materialSet": "plastic/plastic-grey",
                "bumpScale": 0.9,
                "textureScale": 1.3,
                "textureRotation": 0,
                "textureOffsetX": 0.33,
                "textureOffsetY": -0.76,
                "brightness": 0.5,
                "contrast": 1,
                "overrides": {},
                "tintLevel": 0,
                "saturation": 0.9
            },
            {
                "id": 404,
                "name": "Sand",
                "color": "#C2B280",
                "shape": "plank",
                "roughness": 0.85,
                "metalness": 0.1,
                "materialSet": "plastic/plastic-sand",
                "bumpScale": 1.5,
                "textureScale": 1.4,
                "textureRotation": 0,
                "textureOffsetX": -0.65,
                "textureOffsetY": -0.76,
                "brightness": 0.4,
                "contrast": 1,
                "overrides": {},
                "tintLevel": 0
            },
            {
                "id": 403,
                "name": "Redwood",
                "color": "#8D5E52",
                "shape": "plank",
                "roughness": 0.85,
                "metalness": 0.1,
                "materialSet": "plastic/plastic-redwood",
                "bumpScale": 1.9,
                "textureScale": 1.4,
                "textureRotation": 0,
                "textureOffsetX": -0.65,
                "textureOffsetY": -0.76,
                "brightness": 0.5,
                "contrast": 1,
                "overrides": {},
                "tintLevel": 0
            }
        ]
    },
    {
        "id": 5,
        "title": "Natural Wood Alternative",
        "section": "LUMBER colours",
        "subheadingDescriptions": {
            "Accoya®": "Made from an acetylation process using acetic acid. Creates extremely dimensionally stable and durable wood.",
            "Hardened Bamboo": "Thermally modified for extreme density, outperforming hardwoods like Ipe. Fire-resistant, stable, and allows for easy on-site removal of graffiti.",
            "Red Cedar": "Sourced from British Columbia with natural oils that resist insects and decay. It provides superior stability without extra treatment."
        },
        "type": "wood",
        "description": "Premium natural and modified wood options.",
        "items": [
            {
                "id": 501,
                "name": "Accoya® Natural",
                "subheading": "Accoya®",
                "color": "#E3CAA5",
                "shape": "plank",
                "roughness": 0.8,
                "metalness": 0,
                "materialSet": "wood/wood-accoya",
                "bumpScale": 2.7,
                "textureScale": 1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 0.8,
                "contrast": 1.1,
                "overrides": {},
                "tintLevel": 1,
                "saturation": 1
            },
            {
                "id": 1767990374328,
                "name": "Accoya® Grey",
                "subheading": "Accoya®",
                "color": "#8f857e",
                "shape": "plank",
                "roughness": 0.7,
                "metalness": 0.4,
                "materialSet": "wood/wood-accoya",
                "bumpScale": 0,
                "textureScale": 1,
                "textureRotation": 180,
                "textureOffsetX": -0.4,
                "textureOffsetY": -1,
                "brightness": 0.8,
                "contrast": 1.5,
                "overrides": {},
                "tintLevel": 1,
                "saturation": 0.1
            },
            {
                "id": 504,
                "name": "Western Red Cedar",
                "subheading": "Red Cedar",
                "color": "#C77A50",
                "shape": "plank",
                "roughness": 0.8,
                "metalness": 0,
                "materialSet": "wood/wood-redCedar",
                "bumpScale": 1,
                "textureScale": 1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1,
                "overrides": {}
            },
            {
                "id": 503,
                "name": "Hardened Bamboo Dark",
                "subheading": "Hardened Bamboo",
                "color": "#D29F64",
                "shape": "plank",
                "roughness": 1,
                "metalness": 0.15,
                "materialSet": "wood/bamboo-dark",
                "bumpScale": 0.5,
                "textureScale": 1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1,
                "tintLevel": 0,
                "overrides": {}
            },
            {
                "id": 1767990238276,
                "name": "Hardened Bamboo Light",
                "subheading": "Hardened Bamboo",
                "color": "#D29F64",
                "shape": "plank",
                "roughness": 1,
                "metalness": 0.15,
                "materialSet": "wood/bamboo-light",
                "bumpScale": 0.5,
                "textureScale": 1,
                "textureRotation": 0,
                "textureOffsetX": 0,
                "textureOffsetY": 0,
                "brightness": 1,
                "contrast": 1,
                "tintLevel": 0,
                "overrides": {}
            }
        ]
    }
];
let GLOBAL_SETTINGS = {
    "metal": {
        "shape": "cube",
        "rotation": {
            "x": -0.14999999999999927,
            "y": 0.5799999999999987,
            "z": 0
        },
        "scale": 1.15,
        "lightRotation": 1.5,
        "lightTilt": 0,
        "envRotation": 0.56,
        "ambientIntensity": 0.1,
        "lightIntensity": 0.3
    },
    "composite": {
        "shape": "plank",
        "rotation": {
            "x": -0.12999999999999987,
            "y": 0.3499999999999993,
            "z": 0
        },
        "scale": 1.2,
        "lightRotation": 0,
        "lightTilt": 0.3,
        "envRotation": 0,
        "lightIntensity": 0.9,
        "ambientIntensity": 0.3
    }
};            
// -- DATA_END --

        const SHAPE_TYPES = ['sphere', 'cube', 'plank', 'cylinder'];
        
        const textureLoader = new THREE.TextureLoader();
        const textureCache = {};
        let SHARED_GEOMETRIES = {}; 

        // =========================================================================
        // ======================== TEXTURE LOADER LOGIC ===========================
        // =========================================================================

        function toggleGlobal() {
            const el = document.getElementById('global-settings-content');
            el.classList.toggle('collapsed');
            
            // Toggle Icon
            const icon = document.getElementById('global-chevron');
            if (el.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }
        
        function resolveTextureUrl(item, mapType) {
            if (item.overrides && item.overrides[mapType]) {
                const val = item.overrides[mapType];
                if (val === 'BLANK') return null; 
                
                const parts = val.split('/');
                if (parts.length === 2 && MATERIAL_LIBRARY[parts[0]]) {
                    if (SUFFIXES[mapType]) return `textures/${parts[0]}/${parts[1]}${SUFFIXES[mapType]}`;
                }
                return val; 
            }

            if (item.materialSet && item.materialSet !== 'none') {
                const [folder, id] = item.materialSet.split('/');
                if (folder && id && MATERIAL_LIBRARY[folder]) {
                    if (SUFFIXES[mapType]) return `textures/${folder}/${id}${SUFFIXES[mapType]}`;
                }
            }
            return null;
        }

        // 1x1 data URI fallback for 404s
        function getFallbackDataURI(hexColor) {
             const cvs = document.createElement('canvas');
             cvs.width = 1; cvs.height = 1;
             const ctx = cvs.getContext('2d');
             ctx.fillStyle = hexColor;
             ctx.fillRect(0,0,1,1);
             return cvs.toDataURL();
        }

        const FALLBACKS = {
            white: getFallbackDataURI('#FFFFFF'), // For Roughness/Metalness (Multiply by 1 = Slider active)
            black: getFallbackDataURI('#000000'), // For Bump/Displacement (No displacement)
            normal: getFallbackDataURI('#8080FF') // Flat Normal
        };

        function loadTexture(url, scale, rotation, offsetX, offsetY, isColorMap = false) {
            // Helper to apply transforms
            const applyTransforms = (tex) => {
                tex.wrapS = THREE.RepeatWrapping;
                tex.wrapT = THREE.RepeatWrapping;
                tex.repeat.set(scale, scale);
                tex.center.set(0.5, 0.5); 
                tex.rotation = rotation * (Math.PI / 180); 
                tex.offset.set(offsetX, offsetY);
            };

            // Determine proper fallback based on usage context
            let fallbackURI = FALLBACKS.white;
            if(url && url.includes('Displacement')) fallbackURI = FALLBACKS.black;
            if(url && url.includes('Normal')) fallbackURI = FALLBACKS.normal;

            if (!url) return null; 
            
            if (textureCache[url]) {
                const tex = textureCache[url].clone();
                tex.needsUpdate = true;
                applyTransforms(tex);
                return tex;
            }

            const texture = new THREE.TextureLoader().load(
                url, 
                (tex) => {
                    applyTransforms(tex);
                    tex.encoding = isColorMap ? THREE.sRGBEncoding : THREE.LinearEncoding;
                    textureCache[url] = tex;
                },
                undefined, // Progress
                (err) => {
                    // ERROR HANDLER: 404 Not Found
                    const img = new Image();
                    img.src = fallbackURI;
                    img.onload = () => {
                        texture.image = img;
                        texture.needsUpdate = true;
                    };
                }
            );
            
            applyTransforms(texture);
            texture.encoding = isColorMap ? THREE.sRGBEncoding : THREE.LinearEncoding;
            return texture;
        }

        // =========================================================================
        // ============================ 3D ENGINE ==================================
        // =========================================================================

        let canvas, renderer;
        let modalCanvas, modalRenderer;
        let scenes = []; 
        let modalSceneData = null;
        let isAnimating = true;
        let originalGlobalRotation = null;

        function initThree() {
            canvas = document.getElementById('c');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true, preserveDrawingBuffer: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.autoClear = false;
            renderer.setClearColor( 0x000000, 0 );

            modalCanvas = document.getElementById('c-modal');
            modalRenderer = new THREE.WebGLRenderer({ canvas: modalCanvas, alpha: true, antialias: true, preserveDrawingBuffer: true });
            modalRenderer.setPixelRatio(window.devicePixelRatio);
            modalRenderer.toneMapping = THREE.ACESFilmicToneMapping;
            modalRenderer.outputEncoding = THREE.sRGBEncoding;
            modalRenderer.autoClear = false;
            modalRenderer.setClearColor( 0x000000, 0 );

            SHARED_GEOMETRIES = {
                cube: new THREE.RoundedBoxGeometry(1, 1, 1, 8, 0.05), 
                plank: new THREE.RoundedBoxGeometry(1.2, 1.2, 0.5, 2, 0.02),
                cylinder: new THREE.CylinderGeometry(0.5, 0.5, 1.1, 32),
                sphere: new THREE.SphereGeometry(0.7, 64, 64)
            };

            if(GLOBAL_ENV_URL) {
                new THREE.TextureLoader().load(GLOBAL_ENV_URL, function(texture) {
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    texture.wrapS = THREE.RepeatWrapping;
                    texture.wrapT = THREE.RepeatWrapping;
                    window.GLOBAL_ENV_MAP = texture;
                    rebuildApp();
                });
            }
        }

        function createMaterial(item) {
            const scale = item.textureScale || 1.0; 
            const rot = item.textureRotation || 0;
            const offX = item.textureOffsetX || 0;
            const offY = item.textureOffsetY || 0;
            
            const map = loadTexture(resolveTextureUrl(item, 'map'), scale, rot, offX, offY, true);
            const bumpMap = loadTexture(resolveTextureUrl(item, 'bumpMap'), scale, rot, offX, offY);
            const normalMap = loadTexture(resolveTextureUrl(item, 'normalMap'), scale, rot, offX, offY);
            const roughnessMap = loadTexture(resolveTextureUrl(item, 'roughnessMap'), scale, rot, offX, offY);
            const metalnessMap = loadTexture(resolveTextureUrl(item, 'metalnessMap'), scale, rot, offX, offY);

            const bumpStrength = item.bumpScale !== undefined ? parseFloat(item.bumpScale) : 1.0;

            const material = new THREE.MeshPhysicalMaterial({
                color: 0xffffff,
                map: map,
                bumpMap: bumpMap,
                bumpScale: bumpStrength * 0.05,
                normalMap: normalMap,
                normalScale: new THREE.Vector2(bumpStrength, bumpStrength),
                roughnessMap: roughnessMap,
                roughness: item.roughness !== undefined ? parseFloat(item.roughness) : 0.5,
                metalnessMap: metalnessMap,
                metalness: item.metalness !== undefined ? parseFloat(item.metalness) : 0.0,
                envMap: window.GLOBAL_ENV_MAP || null,
                envMapIntensity: 1.2,
                clearcoat: 0.1,
                clearcoatRoughness: 0.1
            });

            material.onBeforeCompile = function(shader) {
                material.userData.shader = shader; 
                
                shader.uniforms.uBrightness = { value: item.brightness ?? 1.0 }; 
                shader.uniforms.uContrast = { value: item.contrast ?? 1.0 };
                shader.uniforms.uSaturation = { value: item.saturation ?? 1.0 };
                shader.uniforms.uTintColor = { value: new THREE.Color(item.color) };
                shader.uniforms.uTintLevel = { value: item.tintLevel ?? 1.0 };

                if (!shader.fragmentShader.includes('uniform float uBrightness')) {
                    shader.fragmentShader = `
                        uniform float uBrightness;
                        uniform float uContrast;
                        uniform float uSaturation;
                        uniform vec3 uTintColor;
                        uniform float uTintLevel;
                    ` + shader.fragmentShader;

                    shader.fragmentShader = shader.fragmentShader.replace(
                        '#include <map_fragment>',
                        `
                        #include <map_fragment>
                        vec3 col = diffuseColor.rgb;
                        
                        vec3 tint = uTintColor;
                        col = mix(col, col * tint, uTintLevel); 

                        float luma = dot(col, vec3(0.2126, 0.7152, 0.0722));
                        vec3 gray = vec3(luma);
                        col = mix(gray, col, uSaturation);
                        
                        col = (col - 0.5) * uContrast + 0.5;
                        col = col * uBrightness;
                        
                        diffuseColor.rgb = max(vec3(0.0), col); 
                        `
                    );
                }
            };
            return material;
        }

        // Helper to find the type of a category
        function getCategoryType(catId) {
            const cat = CATEGORIES.find(c => c.id === catId);
            return cat ? (cat.type || 'metal') : 'metal';
        }

        // Helper to group Wood and Plastic together
        function getSettingsGroup(catId) {
            const type = getCategoryType(catId);
            if (type === 'wood' || type === 'plastic') return 'composite';
            return 'metal';
        }

        function createSceneForItem(element, item, isModal = false) {
            const scene = new THREE.Scene();

            const camera = new THREE.PerspectiveCamera(30, 1, 0.1, 100);
            camera.position.set(0, 1.5, 4.2);
            camera.lookAt(0, 0, 0);

            // --- LIGHTING SETUP ---
            const lightGroup = new THREE.Group();
            scene.add(lightGroup);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1.2); 
            dirLight.position.set(3, 3, 5);
            lightGroup.add(dirLight);
            
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
            fillLight.position.set(-3, 0, 5);
            lightGroup.add(fillLight);
            
            const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
            backLight.position.set(0, 2, -5);
            lightGroup.add(backLight);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); 
            scene.add(ambientLight); 

            // --- GEOMETRY & MATERIAL SETUP ---
            let settingsGroup = 'metal'; 
            let groupId = null;

            for(let c of CATEGORIES) {
                if(c.items.find(i => i.id === item.id)) {
                    groupId = c.id;
                    break;
                }
            }
            if(groupId) settingsGroup = getSettingsGroup(groupId);
            
            if(isModal && currentEditCatId) {
                settingsGroup = getSettingsGroup(currentEditCatId);
            }

            const shapeDef = GLOBAL_SETTINGS[settingsGroup];
            const shapeToUse = shapeDef && shapeDef.shape ? shapeDef.shape : (item.shape || 'sphere');

            const geometry = SHARED_GEOMETRIES[shapeToUse] || SHARED_GEOMETRIES['sphere'];
            const material = createMaterial(item);
            const mesh = new THREE.Mesh(geometry, material);
            
            // --- APPLY TRANSFORMS ---
            if (shapeDef) {
                mesh.rotation.set(shapeDef.rotation.x, shapeDef.rotation.y, shapeDef.rotation.z);
                const s = shapeDef.scale || 1.0;
                mesh.scale.set(s,s,s);
                
                lightGroup.rotation.y = shapeDef.lightRotation || 0;
                lightGroup.rotation.x = shapeDef.lightTilt || 0; 

                // Apply initial Env Rotation to the global map
                if(window.GLOBAL_ENV_MAP) window.GLOBAL_ENV_MAP.offset.x = shapeDef.envRotation || 0;

                if (shapeDef.lightIntensity !== undefined) dirLight.intensity = shapeDef.lightIntensity;
                if (shapeDef.ambientIntensity !== undefined) ambientLight.intensity = shapeDef.ambientIntensity;
            }
            scene.add(mesh);

            const sceneData = { 
                scene, 
                camera, 
                element, 
                mesh, 
                shape: shapeToUse, 
                lightGroup, 
                dirLight,        
                ambientLight,    
                settingsGroup,
                itemId: item.id,
                isDragging: false, 
                lastMouse: {x:0, y:0} 
            };

            // --- INTERACTION ---
            if (isModal) {
                camera.position.z = 3.5; 
                camera.position.y = 1.3; 

                element.addEventListener('mousedown', (e) => {
                    sceneData.isDragging = true;
                    sceneData.lastMouse.x = e.clientX;
                    sceneData.lastMouse.y = e.clientY;
                });
            }
            return sceneData;
        }

        
        function render() {
            if (!isAnimating) return;
            
            if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
                renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
            }
            renderer.setScissorTest(false); renderer.clear(); renderer.setScissorTest(true);

            scenes.forEach((item) => {
                const rect = item.element.getBoundingClientRect();
                if (rect.width <= 0 || rect.height <= 0 || rect.bottom < 0 || rect.top > window.innerHeight) return;
                
                const expansion = 1.5; 
                const w = rect.width; const h = rect.height;
                const wExp = w * expansion; const hExp = h * expansion;
                const left = rect.left - (wExp - w)/2;
                const bottom = window.innerHeight - rect.bottom - (hExp - h)/2;

                renderer.setViewport(left, bottom, wExp, hExp);
                renderer.setScissor(left, bottom, wExp, hExp);
                renderer.render(item.scene, item.camera);
            });
            renderer.setScissorTest(false);

            if (modalSceneData) {
                if (modalCanvas.width !== modalCanvas.clientWidth || modalCanvas.height !== modalCanvas.clientHeight) {
                    modalRenderer.setSize(modalCanvas.clientWidth, modalCanvas.clientHeight, false);
                }
                modalRenderer.setScissorTest(false); modalRenderer.clear(); modalRenderer.setScissorTest(true);
                const rect = modalSceneData.element.getBoundingClientRect();
                if (rect.width > 0) {
                     const bottom = window.innerHeight - rect.bottom;
                     modalRenderer.setViewport(rect.left, bottom, rect.width, rect.height);
                     modalRenderer.setScissor(rect.left, bottom, rect.width, rect.height);
                     modalRenderer.render(modalSceneData.scene, modalSceneData.camera);
                }
                modalRenderer.setScissorTest(false);
            } else {
                modalRenderer.clear(); 
            }
            
            requestAnimationFrame(render);
        }

        window.addEventListener('mouseup', () => {
            scenes.forEach(s => s.isDragging = false);
            if(modalSceneData) modalSceneData.isDragging = false;
        });

        window.addEventListener('mousemove', (e) => {
            const handleDrag = (s) => {
                if (s.isDragging) {
                    const deltaX = (e.clientX - s.lastMouse.x) * 0.01;
                    const deltaY = (e.clientY - s.lastMouse.y) * 0.01;

                    s.mesh.rotation.y += deltaX;
                    s.mesh.rotation.x += deltaY;
                    
                    const isSyncEnabled = document.getElementById('save-angle-check') && document.getElementById('save-angle-check').checked;

                    if (s === modalSceneData && isSyncEnabled && s.settingsGroup) {
                        scenes.forEach(other => {
                            if(other.settingsGroup === s.settingsGroup) {
                                other.mesh.rotation.copy(s.mesh.rotation);
                            }
                        });
                    }
                    
                    s.lastMouse.x = e.clientX; s.lastMouse.y = e.clientY;
                }
            };
            scenes.forEach(handleDrag);
            if(modalSceneData) handleDrag(modalSceneData);
        });

        // =========================================================================
        // ======================== APP LOGIC ======================================
        // =========================================================================

        let currentEditCatId = null, currentEditItemId = null, originalItemState = null;

        function rebuildApp() {
            scenes = [];
            document.getElementById('content-anchor').innerHTML = '';
            renderHTML();
            
            CATEGORIES.forEach(cat => {
                cat.items.forEach(item => {
                    const el = document.getElementById(`scene-${item.id}`);
                    if (el) scenes.push(createSceneForItem(el, item, false));
                });
            });

            if(document.getElementById('editor-modal').classList.contains('active') && currentEditItemId) {
                const cat = CATEGORIES.find(c => c.id === currentEditCatId);
                const item = cat.items.find(i => i.id === currentEditItemId);
                
                if(item) {
                     const group = getSettingsGroup(currentEditCatId);
                     const globalShape = GLOBAL_SETTINGS[group].shape;

                     if (modalSceneData && modalSceneData.shape === globalShape) {
                         const newMat = createMaterial(item);
                         if (modalSceneData.mesh.material) modalSceneData.mesh.material.dispose();
                         modalSceneData.mesh.material = newMat;
                         
                         const defs = GLOBAL_SETTINGS[group];
                         if(defs) {
                            modalSceneData.mesh.scale.setScalar(defs.scale || 1.0);
                            modalSceneData.lightGroup.rotation.y = defs.lightRotation || 0;
                            modalSceneData.lightGroup.rotation.x = defs.lightTilt || 0;
                         }

                     } else {
                         const el = document.getElementById('modal-scene-target');
                         el.innerHTML = ''; 
                         modalSceneData = createSceneForItem(el, item, true);
                     }
                }
            }
        }

        // Helper to generate a single item card
        const renderItemCard = (cat, item, isCompact = false, extraClasses = '') => `
            <div class="flex flex-col group page-break-avoid relative ${extraClasses}">
                <div class="relative w-full aspect-square ${isCompact ? 'mb-2' : 'mb-4'} bg-transparent rounded transition">
                    <div id="scene-${item.id}" class="scene-element"></div>
                    <img id="print-${item.id}" class="print-image" src="" />
                    <div class="item-controls absolute inset-0 z-50 flex flex-col justify-between p-2">
                        <div class="flex justify-end gap-2">
                            <button onclick="duplicateItem(${cat.id}, ${item.id})" class="control-btn"><i class="fas fa-copy text-xs"></i></button>
                            <button onclick="deleteItemDirectly(${cat.id}, ${item.id})" class="control-btn btn-delete text-red-500"><i class="fas fa-trash text-xs"></i></button>
                            <button onclick="openModal(${cat.id}, ${item.id})" class="control-btn"><i class="fas fa-pen text-xs"></i></button>
                        </div>
                        <div class="flex justify-between items-center mt-auto">
                            <button onclick="moveItem(${cat.id}, ${item.id}, -1)" class="control-btn w-8 h-8 opacity-70 hover:opacity-100"><i class="fas fa-chevron-left text-xs"></i></button>
                            <button onclick="moveItem(${cat.id}, ${item.id}, 1)" class="control-btn w-8 h-8 opacity-70 hover:opacity-100"><i class="fas fa-chevron-right text-xs"></i></button>
                        </div>
                    </div>
                </div>
                <div class="text-center"><p class="${isCompact ? 'text-[8px] -mb-1' : 'text-[10px] mb-0'} font-light pt-0 text-[#828282] uppercase leading-tight tracking-wide">${item.name}</p></div>
            </div>
        `;

        function renderHTML() {
            const container = document.getElementById('content-anchor');
            
            // Helper for the Document Header (Logo + Contact + Section Title)
            const getPageHeader = (sectionTitle) => `
                <div class="flex justify-between items-end border-b border-gray-200 pb-4 mb-0">
                    <h1 class="text-4xl font-black text-[#213f7d] tracking-tighter uppercase leading-none">${sectionTitle || 'CATALOG'}</h1>
                    <div class="text-right">
                        <img src="${COMPANY_INFO.logoUrl}" alt="Logo" class="h-12 object-contain mb-2 -mt-2 ml-auto">
                        <p class="text-[10px] text-[#828282] font-medium tracking-wider leading-none">${COMPANY_INFO.contact}</p>
                    </div>
                </div>
            `;

            // Start the logic
            let html = ``;
            let lastSection = "";
            let isFirstPage = true;

            CATEGORIES.forEach((cat, index) => {
                const isNewSection = cat.section && cat.section !== lastSection;
                
                // --- CONFIG FOR CONDENSED VIEW ---
                const isPowderSection = cat.section === "POWDER colours";
                const totalColumns = isPowderSection ? 7 : 5; // 8 Cols for Powders, 5 for Lumber
                const gapSize = isPowderSection ? 'gap-1' : 'gap-2';
                const categoryMargin = isPowderSection ? 'margin-bottom: 0rem;' : 'margin-bottom: 2rem;';
                
                // Specific Check for "Textured Powders" to force a split ONLY if we aren't compressing
                // Since we want all powders on one page, we disable forced breaks for powders
                const isForcedBreak = !isPowderSection && cat.title === "Textured Powders"; 
                
                // --- PAGE BREAK LOGIC ---
                if (isNewSection || isForcedBreak) {
                    
                    if (!isFirstPage) {
                        html += `</div>`; // Close previous page
                        html += `<div class="page-sheet">`; // Start new page
                    } else {
                        html += `<div class="page-sheet">`; // Start first page
                        isFirstPage = false;
                    }

                    // Update tracker for natural section changes
                    if (isNewSection) {
                        lastSection = cat.section;
                    }

                    // --- HEADER LOGIC ---
                    html += getPageHeader(cat.section);
                }

                // --- CATEGORY CONTENT ---
                html += `<div style="${categoryMargin}">`; 

                // 1. Category Title
                html += `
                    <div class="page-break-avoid ${isPowderSection ? 'mb-0 mt-6' : 'mb-4 mt-8'} flex justify-between items-end">
                         <h3 class="text-base font-bold uppercase text-white bg-[#213f7d] w-fit px-2">${cat.title}</h3>
                         ${cat.description ? `<p class="text-[12px] text-[#828282] italic text-right max-w-lg leading-tight pl-4">${cat.description}</p>` : ''}
                    </div>
                `;

                // 2. Sorting Items
                const itemsBySub = {};
                const nullSubItems = [];

                cat.items.forEach(item => {
                    if (item.subheading && item.subheading.trim() !== "") {
                        if (!itemsBySub[item.subheading]) itemsBySub[item.subheading] = [];
                        itemsBySub[item.subheading].push(item);
                    } else {
                        nullSubItems.push(item);
                    }
                });

// 3. Render Null Subheading items
                if (nullSubItems.length > 0) {
                      // SET YOUR CUSTOM LIMIT HERE (e.g., 5 items per row)
                      const maxRowItems = 6; 

                      html += `<div class="grid grid-cols-${totalColumns} ${gapSize} mb-0">
                        ${nullSubItems.map((item, index) => {
                            // Logic: If index is divisible by maxRowItems (and not 0), start new line
                            const forceNewRow = (index > 0 && index % maxRowItems === 0);
                            // 'col-start-1' forces the item to start at the first column of the next row
                            const extraClass = forceNewRow ? 'col-start-1' : '';
                            
                            return renderItemCard(cat, item, isPowderSection, extraClass);
                        }).join('')}
                      </div>`;
                }

                // 4. Render Subgroups (Paired Layout)
                const subKeys = Object.keys(itemsBySub);
                if (subKeys.length > 0) {
                    
                    const renderSubBlock = (subName, items, desc, forceFullWidth = false) => {
                        const count = items.length;
                        
                        if (forceFullWidth) {
                            widthClass = 'w-4/5'; 
                            gridClass = 'grid-cols-2';
                        } else {
                            if (count === 1) { widthClass = 'w-1/5'; gridClass = 'grid-cols-1'; }
                            else if (count === 2) { widthClass = 'w-2/5'; gridClass = 'grid-cols-2'; }
                            else if (count === 3) { widthClass = 'w-3/5'; gridClass = 'grid-cols-3'; }
                        }
                        
                        return `
                            <div>
                                <h4 class="text-xs font-bold text-[#828282] uppercase mt-3 tracking-widest mb-0 pb-0 border-gray-200 w-fit pr-20">${subName}</h4>
                                ${desc ? `<p class="text-[10px] text-[#828282] mb-2 mt-1 leading-relaxed">${desc}</p>` : '<div class="mb-2"></div>'}
                                <div class="${widthClass} grid ${gridClass} gap-2">
                                    ${items.map(item => renderItemCard(cat, item)).join('')}
                                </div>
                            </div>
                        `;
                    };

                    for (let i = 0; i < subKeys.length; i++) {
                        const subName = subKeys[i];
                        const items = itemsBySub[subName];
                        const desc = cat.subheadingDescriptions && cat.subheadingDescriptions[subName] ? cat.subheadingDescriptions[subName] : '';
                        
                        let isPaired = false;

                        // Only pair if both items are small enough to fit on one line together
                        // e.g. if Total Cols is 8, and we have two groups of 4 items, they fit.
                        if (items.length <= 2 && i + 1 < subKeys.length) {
                            const nextSubName = subKeys[i+1];
                            const nextItems = itemsBySub[nextSubName];
                            
                            // Check if combined length is less than or equal to total columns available
                            if (nextItems.length <= 2) {
                                isPaired = true;
                                const nextDesc = cat.subheadingDescriptions && cat.subheadingDescriptions[nextSubName] ? cat.subheadingDescriptions[nextSubName] : '';
                                
                                html += `
                                    <div class="flex gap-8 mb-6 break-inside-avoid">
                                        <div class="w-1/2">
                                            ${renderSubBlock(subName, items, desc, true)} 
                                        </div>
                                        <div class="w-1/2">
                                            ${renderSubBlock(nextSubName, nextItems, nextDesc, true)}
                                        </div>
                                    </div>
                                `;
                                i++; 
                            }
                        }
                        
                        if (!isPaired) {
                            html += `<div class="mb-6 break-inside-avoid">` + renderSubBlock(subName, items, desc, false) + `</div>`;
                        }
                    }
                }

                html += `</div>`; 

            // --- FOOTER LOGIC ---
                // Check if this is the last category of the current section
                const nextCat = CATEGORIES[index + 1];
                const isLastInSection = !nextCat || nextCat.section !== cat.section;

                if (isLastInSection) {
                    let footerText = "";
                    let footerImg = ""; // Variable to hold the optional image URL

                    if (cat.section === "POWDER colours") {
                        footerText = "Custom powder colours can be selected based on the RAL colour management system. Premium powder colours incur a $30 * surcharge per item.";
                        footerImg = "https://upload.wikimedia.org/wikipedia/commons/3/3c/RAL_Colours_logo.svg"; 
                        
                    } else if (cat.section === "LUMBER colours") {
                        footerText = "Stains or oils specified by the customer can optionally be applied by Wishbone during manufacture. Contact us for further details.";
                        footerImg = ""; 
                    }

                    if (footerText) {
                        html += `
                            <div class="mt-auto pt-4 border-t border-gray-200 break-inside-avoid flex items-center gap-4">
                                 ${footerImg ? `<img src="${footerImg}" class="h-12 w-auto object-contain" alt="Footer Icon">` : ''}
                                 <p class="text-[14px] text-[#828282] font-medium leading-relaxed max-w-2xl">
                                    ${footerText}
                                 </p>
                            </div>
                        `;
                    }
                }
            });
            
            html += `</div>`; 
            container.innerHTML = html;
        }

        
        function toggleAdvanced() {
            const panel = document.getElementById('advanced-overrides');
            panel.classList.toggle('open');
            const icon = document.getElementById('adv-icon');
            icon.classList.toggle('fa-chevron-down'); icon.classList.toggle('fa-chevron-up');
        }

        function updateSyncState(key, checked) {
            SYNC_STATE[key] = checked;
        }

        function toggleAngleSync(isChecked) {
            if(!modalSceneData) return;
            
            if (!isChecked) {
                // Snap visual preview back to the GLOBAL default settings instantly
                const group = getSettingsGroup(currentEditCatId);
                const defs = GLOBAL_SETTINGS[group];
                if(defs && defs.rotation) {
                    modalSceneData.mesh.rotation.set(defs.rotation.x, defs.rotation.y, defs.rotation.z);
                }
            } else {
                 const group = getSettingsGroup(currentEditCatId);
                 const defs = GLOBAL_SETTINGS[group];
                 if(defs && defs.rotation) {
                    modalSceneData.mesh.rotation.set(defs.rotation.x, defs.rotation.y, defs.rotation.z);
                    scenes.forEach(s => {
                        if(s.settingsGroup === group) {
                             s.mesh.rotation.set(defs.rotation.x, defs.rotation.y, defs.rotation.z);
                        }
                    });
                 }
            }
        }

        function openModal(catId, itemId) {
            currentEditCatId = catId; currentEditItemId = itemId;
            
            // --- RESET ALL SYNC STATES ON OPEN ---
            SYNC_STATE.material = false;
            SYNC_STATE.physics = false;
            SYNC_STATE.filters = false;
            // The Angle Sync checkbox is reset below via DOM manipulation

            const cat = CATEGORIES.find(c => c.id === catId);
            const item = cat.items.find(i => i.id === itemId);
            const catType = cat.type || 'metal'; 
            const settingsGroup = getSettingsGroup(catId); 
            const catTitle = cat.title; 

            // 1. Capture Original Item State (for Cancel)
            originalItemState = JSON.parse(JSON.stringify(item));

            // 2. Capture Original Global Rotation (for Cancel)
            if(GLOBAL_SETTINGS[settingsGroup]) {
                originalGlobalRotation = { ...GLOBAL_SETTINGS[settingsGroup].rotation };
            }

            const generateOptions = (val, showAll = false) => {
                let opts = `<option value="" ${!val ? 'selected' : ''}>Default (From Set)</option>
                            <option value="BLANK" ${val === 'BLANK' ? 'selected' : ''}>-- NONE / BLANK --</option>`;
                
                for (const [folder, mats] of Object.entries(MATERIAL_LIBRARY)) {
                    if (showAll || folder === catType) {
                        opts += `<optgroup label="${folder.toUpperCase()}">`;
                        mats.forEach(id => opts += `<option value="${folder}/${id}" ${val === `${folder}/${id}` ? 'selected' : ''}>${id}</option>`);
                        opts += `</optgroup>`;
                    }
                }
                return opts;
            };

            // Get unique existing subheadings for the datalist
            const existingSubheadings = [...new Set(cat.items.map(i => i.subheading).filter(s => s))];
            const datalistOpts = existingSubheadings.map(s => `<option value="${s}">`).join('');

            const shapeDef = GLOBAL_SETTINGS[settingsGroup] || { scale: 1, lightRotation: 0, lightTilt: 0, envRotation: 0 };
            
            document.getElementById('modal-controls').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-[#828282] mb-1">Name</label>
                        <input type="text" value="${item.name}" onchange="updateCurrentItem('name', this.value)" class="w-full border rounded p-2 text-sm font-bold text-[#828282]">
                    </div>
                    
                    <div>
                        <label class="block text-xs  font-bold text-[#828282] mb-1">Subheading</label>
                        <input list="subheading-list" type="text" value="${item.subheading || ''}" onchange="updateCurrentItem('subheading', this.value)" placeholder="None (Top Level)" class="w-full border rounded p-2 text-sm">
                        <datalist id="subheading-list">${datalistOpts}</datalist>
                    </div>

                    <div><label class="block text-xs font-bold text-[#828282] mb-1">Shape</label>
                        <select onchange="updateGlobalShape(this.value)" class="w-full border rounded p-2 bg-white">${SHAPE_TYPES.map(t => `<option value="${t}" ${GLOBAL_SETTINGS[settingsGroup].shape === t ? 'selected' : ''}>${t.toUpperCase()}</option>`).join('')}</select>
                    </div>
                </div>

                 <div class="bg-gray-100 p-3 rounded-lg border border-[#828282] mt-4">
                    <h4 class="text-xs font-bold text-[#828282] uppercase mb-3 flex items-center gap-2"><i class="fas fa-globe"></i> Global ${settingsGroup.toUpperCase()} Settings</h4>
                    <div class="space-y-3">
                         <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Shape Scale</label><input type="range" min="0.5" max="1.5" step="0.05" value="${shapeDef.scale||1}" oninput="updateGlobalPreview('scale', this.value)"></div>
                        <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Light Rotate</label><input type="range" min="0" max="6.28" step="0.1" value="${shapeDef.lightRotation||0}" oninput="updateGlobalPreview('lightRotation', this.value)"></div>
                        <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Light Tilt</label><input type="range" min="-1.5" max="1.5" step="0.1" value="${shapeDef.lightTilt||0}" oninput="updateGlobalPreview('lightTilt', this.value)"></div>
                         <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Env Rotation</label><input type="range" min="0" max="1" step="0.01" value="${shapeDef.envRotation||0}" oninput="updateGlobalPreview('envRotation', this.value)"></div>
                         
                         <hr class="border-gray-300">
                         <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Light Intensity</label><input type="range" min="0" max="3" step="0.1" value="${shapeDef.lightIntensity!==undefined ? shapeDef.lightIntensity : 1.2}" oninput="updateGlobalPreview('lightIntensity', this.value)"></div>
                         <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Shadow Soft</label><input type="range" min="0" max="2" step="0.1" value="${shapeDef.ambientIntensity!==undefined ? shapeDef.ambientIntensity : 0.4}" oninput="updateGlobalPreview('ambientIntensity', this.value)"></div>
                    </div>
                </div>

                <hr class="border-[#828282] my-4">

                <div class="mb-4">
                    <div class="flex justify-between items-end mb-1">
                        <label class="block text-xs font-bold text-[#828282]">Material Set (${catType.toUpperCase()})</label>
                        <div class="flex items-center gap-1">
                            <input type="checkbox" id="sync-material" class="accent-blue-600 cursor-pointer" ${SYNC_STATE.material ? 'checked' : ''} onchange="updateSyncState('material', this.checked)">
                            <label for="sync-material" class="text-[10px] text-blue-600 font-bold cursor-pointer select-none">Sync ${catTitle}</label>
                        </div>
                    </div>
                    <select onchange="updateCurrentItem('materialSet', this.value)" class="w-full border-2 border-blue-100 rounded p-2 font-bold text-[#828282]">
                        <option value="none" ${item.materialSet === 'none' ? 'selected' : ''}>None (Color Only)</option>
                        ${generateOptions(item.materialSet, false).replace('Default (From Set)', '').replace('BLANK', '')} 
                    </select>
                </div>

                <div class="border border-[#828282] rounded-lg overflow-hidden">
                    <button onclick="toggleAdvanced()" class="w-full bg-gray-50 p-2 text-left flex justify-between items-center hover:bg-gray-100">
                        <span class="text-xs font-bold text-[#828282]">Advanced / Manual Overrides</span><i id="adv-icon" class="fas fa-chevron-down text-[#828282] text-xs"></i>
                    </button>
                    <div id="advanced-overrides" class="advanced-panel bg-white p-3 space-y-3">
                        <p class="text-[10px] text-[#828282] italic">Overrides allow you to select ANY texture from ANY category.</p>
                        ${['map', 'bumpMap', 'normalMap', 'roughnessMap', 'metalnessMap'].map(key => `
                            <div><label class="block text-[10px] font-bold text-[#828282] capitalize">${key} Override</label>
                            <select onchange="updateOverride('${key}', this.value)" class="w-full border rounded p-1 text-xs text-[#828282]">${generateOptions(item.overrides?.[key], true)}</select></div>
                        `).join('')}
                    </div>
                </div>

                <div class="space-y-4 pt-2 mt-4 bg-gray-50 p-2 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="text-xs font-bold uppercase text-[#828282]">Material Physics</h5>
                        <div class="flex items-center gap-1">
                            <input type="checkbox" id="sync-physics" class="accent-blue-600 cursor-pointer" ${SYNC_STATE.physics ? 'checked' : ''} onchange="updateSyncState('physics', this.checked)">
                            <label for="sync-physics" class="text-[10px] text-blue-600 font-bold cursor-pointer select-none">Sync ${catTitle}</label>
                        </div>
                    </div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Gloss/Rough</label><input type="range" min="0" max="1" step="0.05" value="${item.roughness}" oninput="updateMaterialProp('roughness', this.value)"></div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Metalness</label><input type="range" min="0" max="1" step="0.05" value="${item.metalness}" oninput="updateMaterialProp('metalness', this.value)"></div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Texture Depth</label><input type="range" min="0" max="3" step="0.1" value="${item.bumpScale !== undefined ? item.bumpScale : 1.0}" oninput="updateMaterialProp('bumpScale', this.value)"></div>
                    
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Texture Scale</label><input type="range" min="0.1" max="5.0" step="0.1" value="${item.textureScale}" oninput="updateMaterialProp('textureScale', this.value)"></div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Tex Rotate</label><input type="range" min="0" max="360" step="1" value="${item.textureRotation||0}" oninput="updateMaterialProp('textureRotation', this.value)"></div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Tex Offset X</label><input type="range" min="-1" max="1" step="0.01" value="${item.textureOffsetX||0}" oninput="updateMaterialProp('textureOffsetX', this.value)"></div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Tex Offset Y</label><input type="range" min="-1" max="1" step="0.01" value="${item.textureOffsetY||0}" oninput="updateMaterialProp('textureOffsetY', this.value)"></div>
                </div>

                <div class="space-y-4 pt-2 mt-2 bg-gray-50 p-2 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="text-xs font-bold uppercase text-[#828282]">Filters (No Tint)</h5>
                        <div class="flex items-center gap-1">
                            <input type="checkbox" id="sync-filters" class="accent-blue-600 cursor-pointer" ${SYNC_STATE.filters ? 'checked' : ''} onchange="updateSyncState('filters', this.checked)">
                            <label for="sync-filters" class="text-[10px] text-blue-600 font-bold cursor-pointer select-none">Sync ${catTitle}</label>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 border-b border-gray-200 pb-4 mb-2">
                        <label class="w-24 text-xs font-bold text-[#828282]">Tint Color</label>
                        <input type="color" value="${item.color}" oninput="updateMaterialProp('color', this.value)" class="w-10 h-8 rounded border border-gray-300 cursor-pointer p-0">
                        <div class="flex-1 flex items-center gap-2">
                             <label class="text-[10px] font-bold text-[#828282]">Str</label>
                             <input type="range" min="0" max="1" step="0.05" value="${item.tintLevel !== undefined ? item.tintLevel : 1.0}" oninput="updateMaterialProp('tintLevel', this.value)">
                        </div>
                    </div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Brightness</label><input type="range" min="0.0" max="2.0" step="0.1" value="${item.brightness ?? 1}" oninput="updateMaterialProp('brightness', this.value)"></div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Contrast</label><input type="range" min="0.5" max="2.0" step="0.1" value="${item.contrast ?? 1}" oninput="updateMaterialProp('contrast', this.value)"></div>
                    <div class="flex items-center gap-4"><label class="w-24 text-xs font-bold text-[#828282]">Saturation</label><input type="range" min="0.0" max="2.0" step="0.1" value="${item.saturation ?? 1}" oninput="updateMaterialProp('saturation', this.value)"></div>
                </div>
            `;
            
            const angleCheck = document.getElementById('save-angle-check');
            if(angleCheck) {
                // RESET ANGLE TOGGLE TO FALSE
                angleCheck.checked = false;
                angleCheck.onchange = (e) => toggleAngleSync(e.target.checked);
            }

            document.getElementById('editor-modal').classList.add('active');
            rebuildApp();
        }

        function updateGlobalShape(newShape) {
            const group = getSettingsGroup(currentEditCatId);
            if(GLOBAL_SETTINGS[group]) {
                GLOBAL_SETTINGS[group].shape = newShape;

                scenes.forEach(s => {
                    if(s.settingsGroup === group) {
                        s.shape = newShape;
                        s.mesh.geometry = SHARED_GEOMETRIES[newShape];
                    }
                });

                if(modalSceneData) {
                    modalSceneData.shape = newShape;
                    modalSceneData.mesh.geometry = SHARED_GEOMETRIES[newShape];
                }
            }
        }

        function updateGlobalPreview(type, value) {
            const group = getSettingsGroup(currentEditCatId);
            
            if (GLOBAL_SETTINGS[group]) {
                const val = parseFloat(value);
                
                if (type === 'scale') GLOBAL_SETTINGS[group].scale = val;
                else if (type === 'lightRotation') GLOBAL_SETTINGS[group].lightRotation = val;
                else if (type === 'lightTilt') GLOBAL_SETTINGS[group].lightTilt = val;
                else if (type === 'envRotation') GLOBAL_SETTINGS[group].envRotation = val;
                else if (type === 'lightIntensity') GLOBAL_SETTINGS[group].lightIntensity = val;
                else if (type === 'ambientIntensity') GLOBAL_SETTINGS[group].ambientIntensity = val;

                if (type === 'envRotation' && window.GLOBAL_ENV_MAP) {
                    window.GLOBAL_ENV_MAP.offset.x = val;
                }

                const applyToScene = (s) => {
                    if (type === 'scale') s.mesh.scale.setScalar(val);
                    else if (type === 'lightRotation') s.lightGroup.rotation.y = val;
                    else if (type === 'lightTilt') s.lightGroup.rotation.x = val;
                    else if (type === 'lightIntensity' && s.dirLight) s.dirLight.intensity = val;
                    else if (type === 'ambientIntensity' && s.ambientLight) s.ambientLight.intensity = val;
                };

                if (modalSceneData) applyToScene(modalSceneData);

                scenes.forEach(s => {
                    if(s.settingsGroup === group) applyToScene(s);
                });
            }
        }

        function saveAndCloseModal() { 
            const isSyncAngle = document.getElementById('save-angle-check')?.checked;

            if (modalSceneData && modalSceneData.settingsGroup) {
                const cat = CATEGORIES.find(c => c.id === currentEditCatId);
                const item = cat.items.find(i => i.id === currentEditItemId);

                if (isSyncAngle) {
                    const currentRot = {
                        x: modalSceneData.mesh.rotation.x,
                        y: modalSceneData.mesh.rotation.y,
                        z: modalSceneData.mesh.rotation.z
                    };
                    
                    if (GLOBAL_SETTINGS[modalSceneData.settingsGroup]) {
                        GLOBAL_SETTINGS[modalSceneData.settingsGroup].rotation = currentRot;
                    }
                    if (item.rotation) delete item.rotation; 
                } 
            }
            closeModal(); 
        }

        function closeModal() {
            document.getElementById('editor-modal').classList.remove('active');
            currentEditCatId = null; currentEditItemId = null; originalItemState = null;
            if (modalSceneData) {
                if (modalSceneData.mesh && modalSceneData.mesh.material) modalSceneData.mesh.material.dispose();
                modalSceneData = null;
            }
            rebuildApp(); 
        }

        function updateMaterialProp(field, value) {
            const cat = CATEGORIES.find(c => c.id === currentEditCatId);
            const currentItem = cat.items.find(i => i.id === currentEditItemId);
            
            const isPhysics = ['roughness', 'metalness', 'bumpScale', 'textureScale', 'textureRotation', 'textureOffsetX', 'textureOffsetY'].includes(field);
            const isFilter = ['brightness', 'contrast', 'saturation'].includes(field); 
            
            let itemsToUpdate = [currentItem];

            if (isPhysics && SYNC_STATE.physics) {
                itemsToUpdate = cat.items;
            } else if (isFilter && SYNC_STATE.filters) {
                itemsToUpdate = cat.items;
            }

            itemsToUpdate.forEach(item => {
                if (['color', 'name'].includes(field)) item[field] = value;
                else item[field] = parseFloat(value);

                const updateTarget = (sceneData) => {
                    if(!sceneData || !sceneData.mesh || !sceneData.mesh.material) return;
                    const mat = sceneData.mesh.material;
                    const shader = mat.userData.shader;

                    if(field === 'roughness') mat.roughness = item.roughness;
                    if(field === 'metalness') mat.metalness = item.metalness;
                    
                    if(field === 'bumpScale') {
                        mat.bumpScale = item.bumpScale * 0.05; 
                        mat.normalScale.set(item.bumpScale, item.bumpScale);
                    }

                    if(['textureScale', 'textureRotation', 'textureOffsetX', 'textureOffsetY'].includes(field)) {
                        ['map', 'bumpMap', 'normalMap', 'roughnessMap', 'metalnessMap'].forEach(mapType => {
                            if(mat[mapType]) {
                                mat[mapType].repeat.set(item.textureScale, item.textureScale);
                                mat[mapType].rotation = (item.textureRotation || 0) * (Math.PI/180);
                                mat[mapType].offset.set(item.textureOffsetX || 0, item.textureOffsetY || 0);
                            }
                        });
                    }

                    if (shader) {
                        if(field === 'brightness') shader.uniforms.uBrightness.value = item.brightness;
                        if(field === 'contrast') shader.uniforms.uContrast.value = item.contrast;
                        if(field === 'saturation') shader.uniforms.uSaturation.value = item.saturation;
                        if(field === 'tintLevel') shader.uniforms.uTintLevel.value = item.tintLevel;
                        if(field === 'color') shader.uniforms.uTintColor.value.set(item.color);
                    }
                };

                if(modalSceneData && modalSceneData.itemId === item.id) updateTarget(modalSceneData);
                const gridScene = scenes.find(s => s.itemId === item.id);
                updateTarget(gridScene);
            });
        }

        function updateCurrentItem(field, value) {
            const cat = CATEGORIES.find(c => c.id === currentEditCatId);
            const item = cat.items.find(i => i.id === currentEditItemId);
            
            if (field === 'materialSet') {
                if (SYNC_STATE.material) {
                    cat.items.forEach(i => {
                        i.materialSet = value;
                        i.overrides = {};
                    });
                } else {
                    item[field] = value;
                    item.overrides = {}; 
                }
            } else {
                item[field] = value;
            }
            rebuildApp();
        }

        function updateOverride(type, value) {
            const cat = CATEGORIES.find(c => c.id === currentEditCatId);
            const item = cat.items.find(i => i.id === currentEditItemId);
            if (!item.overrides) item.overrides = {};
            if (value.trim() === '') delete item.overrides[type];
            else item.overrides[type] = value;
            rebuildApp();
        }

        function deleteCurrentItem() { if(confirm("Delete?")) { const cat = CATEGORIES.find(c => c.id === currentEditCatId); cat.items = cat.items.filter(i => i.id !== currentEditItemId); closeModal(); } }
        function deleteItemDirectly(catId, itemId) { if(confirm("Delete?")) { const cat = CATEGORIES.find(c => c.id === catId); cat.items = cat.items.filter(i => i.id !== itemId); rebuildApp(); } }
        function cancelEdit() { 
            const group = getSettingsGroup(currentEditCatId);

            if (originalItemState) {
                const cat = CATEGORIES.find(c => c.id === currentEditCatId);
                const item = cat.items.find(i => i.id === currentEditItemId);
                Object.assign(item, originalItemState);
            }

            if (originalGlobalRotation && GLOBAL_SETTINGS[group]) {
                GLOBAL_SETTINGS[group].rotation = { ...originalGlobalRotation };
            }

            if (originalGlobalRotation) {
                 scenes.forEach(s => {
                    if(s.settingsGroup === group) {
                         s.mesh.rotation.set(originalGlobalRotation.x, originalGlobalRotation.y, originalGlobalRotation.z);
                    }
                });
            }
            closeModal(); 
        }

        function duplicateItem(catId, itemId) {
            const cat = CATEGORIES.find(c => c.id === catId);
            const index = cat.items.findIndex(i => i.id === itemId);
            const newItem = JSON.parse(JSON.stringify(cat.items[index]));
            newItem.id = Date.now(); newItem.name += " (Copy)";
            cat.items.splice(index + 1, 0, newItem);
            rebuildApp();
        }

        function moveItem(catId, itemId, dir) {
            const cat = CATEGORIES.find(c => c.id === catId);
            const idx = cat.items.findIndex(i => i.id === itemId);
            if (dir === -1 && idx > 0) [cat.items[idx], cat.items[idx-1]] = [cat.items[idx-1], cat.items[idx]];
            else if (dir === 1 && idx < cat.items.length - 1) [cat.items[idx], cat.items[idx+1]] = [cat.items[idx+1], cat.items[idx]];
            rebuildApp();
        }

        function downloadHTML() {
            let html = document.documentElement.outerHTML;
            const scriptData = `let CATEGORIES = ${JSON.stringify(CATEGORIES, null, 4)};\nlet GLOBAL_SETTINGS = ${JSON.stringify(GLOBAL_SETTINGS, null, 4)};`;
            html = html.replace(/\/\/ -- DATA_START --[\s\S]*?\/\/ -- DATA_END --/, `// -- DATA_START --\n${scriptData}\n// -- DATA_END --`);
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'wishbone-catalog-saved.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function copyHTMLCode() {
            const code = `let CATEGORIES = ${JSON.stringify(CATEGORIES, null, 4)};\nlet GLOBAL_SETTINGS = ${JSON.stringify(GLOBAL_SETTINGS, null, 4)};`;

            navigator.clipboard.writeText(code).then(() => {
                alert("Categories code copied successfully!");
            }).catch(err => {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert("Categories code copied successfully!");
            });
        }

        function togglePrintMenu() {
            document.getElementById('print-menu').classList.toggle('hidden');
        }

        window.addEventListener('click', (e) => {
            const menu = document.getElementById('print-menu');
            const btn = document.querySelector('button[onclick="togglePrintMenu()"]');
            if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && (!btn || !btn.contains(e.target))) {
                menu.classList.add('hidden');
            }
        });

        async function prepareAndPrint(qualitySetting) {
            document.getElementById('print-menu').classList.add('hidden');
            isAnimating = false;
            if(document.getElementById('editor-modal').classList.contains('active')) closeModal();
            
            let size = 1024;
            let format = 'image/png';
            let quality = undefined;

            if (qualitySetting === 'normal') {
                size = 512; format = 'image/webp'; quality = 0.8;
            }

            renderer.setSize(size, size);
            
            for (const item of scenes) {
                const group = item.settingsGroup;
                const shapeDef = GLOBAL_SETTINGS[group];
                
                if(shapeDef) {
                    item.mesh.rotation.set(shapeDef.rotation.x, shapeDef.rotation.y, shapeDef.rotation.z);
                    item.mesh.scale.setScalar(shapeDef.scale || 1.0);
                    item.lightGroup.rotation.y = shapeDef.lightRotation || 0;
                    item.lightGroup.rotation.x = shapeDef.lightTilt || 0; 
                    if(window.GLOBAL_ENV_MAP) window.GLOBAL_ENV_MAP.offset.x = shapeDef.envRotation || 0;

                    if (shapeDef.lightIntensity !== undefined && item.dirLight) item.dirLight.intensity = shapeDef.lightIntensity;
                    if (shapeDef.ambientIntensity !== undefined && item.ambientLight) item.ambientLight.intensity = shapeDef.ambientIntensity;
                }

                const originalZoom = item.camera.zoom;
                item.camera.zoom = 1.1; 
                item.camera.updateProjectionMatrix();

                renderer.clear();
                renderer.render(item.scene, item.camera);

                item.camera.zoom = originalZoom;
                item.camera.updateProjectionMatrix();

                const img = document.getElementById(`print-${item.element.id.split('-')[1]}`);
                if (img) img.src = renderer.domElement.toDataURL(format, quality);
            }
            
            setTimeout(() => { 
                window.print(); 
                isAnimating = true; 
                if(canvas) renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
                requestAnimationFrame(render); 
            }, 500);
        }

        window.onload = function() { initThree(); rebuildApp(); render(); };
    </script>

</body>
</html>